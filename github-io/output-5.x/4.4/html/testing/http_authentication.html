

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>How to Simulate HTTP Authentication in a Functional Test &mdash; Symfony Framework Documentation  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/rtd_custom.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to Test the Interaction of several Clients" href="insulating_clients.html" />
    <link rel="prev" title="Functional Test specific Assertions" href="functional_tests_assertions.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #f0f0f0" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/symfony-logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                4.4}
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../quick_tour/index.html">The Quick Tour</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index.html">Getting Started</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../best_practices.html">The Symfony Framework Best Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bundles.html">The Bundle System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cache.html">Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../console.html">Console Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doctrine.html">Databases and the Doctrine ORM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment.html">How to Deploy a Symfony Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../email.html">Swift Mailer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../event_dispatcher.html">Events and Event Listeners</a></li>
<li class="toctree-l1"><a class="reference internal" href="../forms.html">Forms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../frontend.html">Managing CSS and JavaScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../http_cache.html">HTTP Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../http_client.html">HTTP Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lock.html">Dealing with Concurrency with Locks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mailer.html">Sending Emails with Mailer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mercure.html">Pushing Data to Clients Using the Mercure Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../messenger.html">Messenger: Sync &amp; Queued Message Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration.html">Migrating an Existing Application to Symfony</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../profiler.html">Profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../routing.html">Routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../session.html">Sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup.html">Installing &amp; Setting up the Symfony Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../serializer.html">How to Use the Serializer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../service_container.html">Service Container</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../testing.html">Testing</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../testing.html#the-phpunit-testing-framework">The PHPUnit Testing Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#unit-tests">Unit Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#functional-tests">Functional Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#testing-against-different-sets-of-data">Testing against Different Sets of Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#working-with-the-test-client">Working with the Test Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#the-crawler">The Crawler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#testing-configuration">Testing Configuration</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../testing.html#learn-more">Learn more</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="bootstrap.html">How to Customize the Bootstrap Process before Running Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="database.html">How to Test Code that Interacts with the Database</a></li>
<li class="toctree-l3"><a class="reference internal" href="functional_tests_assertions.html">Functional Test specific Assertions</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">How to Simulate HTTP Authentication in a Functional Test</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#using-a-faster-authentication-mechanism-only-for-tests">Using a Faster Authentication Mechanism Only for Tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-the-authentication-token">Creating the Authentication Token</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="insulating_clients.html">How to Test the Interaction of several Clients</a></li>
<li class="toctree-l3"><a class="reference internal" href="profiling.html">How to Use the Profiler in a Functional Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../components/dom_crawler.html">The DomCrawler Component</a></li>
<li class="toctree-l3"><a class="reference internal" href="../components/css_selector.html">The CssSelector Component</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../translation.html">Translations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../validation.html">Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../web_link.html">Asset Preloading and Resource Hints with HTTP/2 and WebLink</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflow.html">Workflow</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../components/index.html">The Components</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference Documents</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../create_framework/index.html">Create your own PHP Framework</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Symfony Framework Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../testing.html">Testing</a> &raquo;</li>
        
      <li>How to Simulate HTTP Authentication in a Functional Test</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/testing/http_authentication.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="how-to-simulate-http-authentication-in-a-functional-test">
<span id="index-0"></span><h1>How to Simulate HTTP Authentication in a Functional Test<a class="headerlink" href="#how-to-simulate-http-authentication-in-a-functional-test" title="Permalink to this headline">¶</a></h1>
<p>Authenticating requests in functional tests can slow down the entire test suite.
This could become an issue especially when the tests reproduce the same steps
that users follow to authenticate, such as submitting a login form or using
OAuth authentication services.</p>
<p>This article explains the two most popular techniques to avoid these issues and
create fast tests when using authentication.</p>
<div class="section" id="using-a-faster-authentication-mechanism-only-for-tests">
<h2>Using a Faster Authentication Mechanism Only for Tests<a class="headerlink" href="#using-a-faster-authentication-mechanism-only-for-tests" title="Permalink to this headline">¶</a></h2>
<p>When your application is using a <code class="docutils literal notranslate"><span class="pre">form_login</span></code> authentication, you can make
your tests faster by allowing them to use HTTP authentication. This way your
tests authenticate with the simple and fast HTTP Basic method whilst your real
users still log in via the normal login form.</p>
<p>The trick is to use the <code class="docutils literal notranslate"><span class="pre">http_basic</span></code> authentication in your application
firewall, but only in the configuration file used by tests:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># config/packages/test/security.yaml</span>
<span class="l l-Scalar l-Scalar-Plain">security</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">firewalls</span><span class="p p-Indicator">:</span>
        <span class="c1"># replace &#39;main&#39; by the name of your own firewall</span>
        <span class="l l-Scalar l-Scalar-Plain">main</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">http_basic</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">~</span>
</pre></div>
</td></tr></table></div>
</li>
<li><em>XML</em><div class="highlight-xml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- config/packages/test/security.xml --&gt;</span>
<span class="nt">&lt;security:config&gt;</span>
    <span class="c">&lt;!-- replace &#39;main&#39; by the name of your own firewall --&gt;</span>
    <span class="nt">&lt;security:firewall</span> <span class="na">name=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;security:http-basic/&gt;</span>
    <span class="nt">&lt;/security:firewall&gt;</span>
<span class="nt">&lt;/security:config&gt;</span>
</pre></div>
</td></tr></table></div>
</li>
<li><em>PHP</em><div class="highlight-php notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// config/packages/test/security.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">&#39;firewalls&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="c1">// replace &#39;main&#39; by the name of your own firewall</span>
        <span class="s1">&#39;main&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;http_basic&#39;</span> <span class="o">=&gt;</span> <span class="p">[],</span>
        <span class="p">],</span>
    <span class="p">],</span>
<span class="p">]);</span>
</pre></div>
</td></tr></table></div>
</li>
</ul>
</div>
<p>Tests can now authenticate via HTTP passing the username and password as server
variables using the second argument of <code class="docutils literal notranslate"><span class="pre">createClient()</span></code>:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$client</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="na">createClient</span><span class="p">([],</span> <span class="p">[</span>
    <span class="s1">&#39;PHP_AUTH_USER&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PHP_AUTH_PW&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;pa$$word&#39;</span><span class="p">,</span>
<span class="p">]);</span>
</pre></div>
</div>
<p>The username and password can also be passed on a per request basis:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$client</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s1">&#39;/post/12&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[</span>
    <span class="s1">&#39;PHP_AUTH_USER&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PHP_AUTH_PW&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;pa$$word&#39;</span><span class="p">,</span>
<span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-the-authentication-token">
<h2>Creating the Authentication Token<a class="headerlink" href="#creating-the-authentication-token" title="Permalink to this headline">¶</a></h2>
<p>If your application uses a more advanced authentication mechanism, you can’t
use the previous trick, but it’s still possible to make tests faster. The trick
now is to bypass the authentication process, create the <em>authentication token</em>
yourself and store it in the session.</p>
<p>This technique requires some knowledge of the Security component internals,
but the following example shows a complete example that you can adapt to your
needs:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// tests/Controller/DefaultControllerTest.php</span>
<span class="k">namespace</span> <span class="nx">App\Tests\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Test\WebTestCase</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\BrowserKit\Cookie</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Response</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\Authentication\Token\UsernamePasswordToken</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">DefaultControllerTest</span> <span class="k">extends</span> <span class="nx">WebTestCase</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$client</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="na">createClient</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testSecuredHello</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logIn</span><span class="p">();</span>
        <span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/admin&#39;</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertSame</span><span class="p">(</span><span class="nx">Response</span><span class="o">::</span><span class="na">HTTP_OK</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span><span class="o">-&gt;</span><span class="na">getResponse</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getStatusCode</span><span class="p">());</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertSame</span><span class="p">(</span><span class="s1">&#39;Admin Dashboard&#39;</span><span class="p">,</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">text</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">logIn</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$session</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">);</span>

        <span class="c1">// somehow fetch the user (e.g. using the user repository)</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>

        <span class="nv">$firewallName</span> <span class="o">=</span> <span class="s1">&#39;secure_area&#39;</span><span class="p">;</span>
        <span class="c1">// if you don&#39;t define multiple connected firewalls, the context defaults to the firewall name</span>
        <span class="c1">// See https://symfony.com/doc/current/reference/configuration/security.html#firewall-context</span>
        <span class="nv">$firewallContext</span> <span class="o">=</span> <span class="s1">&#39;secured_area&#39;</span><span class="p">;</span>

        <span class="c1">// you may need to use a different token class depending on your application.</span>
        <span class="c1">// for example, when using Guard authentication you must instantiate PostAuthenticationGuardToken</span>
        <span class="nv">$token</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UsernamePasswordToken</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$firewallName</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">getRoles</span><span class="p">());</span>
        <span class="nv">$session</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;_security_&#39;</span><span class="o">.</span><span class="nv">$firewallContext</span><span class="p">,</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$token</span><span class="p">));</span>
        <span class="nv">$session</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

        <span class="nv">$cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Cookie</span><span class="p">(</span><span class="nv">$session</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">(),</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">());</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span><span class="o">-&gt;</span><span class="na">getCookieJar</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nv">$cookie</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2004-2020 Fabien Potencier

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>