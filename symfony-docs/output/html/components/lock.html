

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>The Lock Component &mdash; Symfony Framework Documentation  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/rtd_custom.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="The Messenger Component" href="messenger.html" />
    <link rel="prev" title="The Ldap Component" href="ldap.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #f0f0f0" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/symfony-logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                5.2}
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../quick_tour/index.html">The Quick Tour</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index.html">Getting Started</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../best_practices.html">The Symfony Framework Best Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bundles.html">The Bundle System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cache.html">Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../console.html">Console Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doctrine.html">Databases and the Doctrine ORM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment.html">How to Deploy a Symfony Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../email.html">Swift Mailer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../event_dispatcher.html">Events and Event Listeners</a></li>
<li class="toctree-l1"><a class="reference internal" href="../forms.html">Forms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../frontend.html">Managing CSS and JavaScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../http_cache.html">HTTP Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../http_client.html">HTTP Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lock.html">Dealing with Concurrency with Locks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mailer.html">Sending Emails with Mailer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mercure.html">Pushing Data to Clients Using the Mercure Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../messenger.html">Messenger: Sync &amp; Queued Message Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration.html">Migrating an Existing Application to Symfony</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notifier.html">Creating and Sending Notifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../profiler.html">Profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rate_limiter.html">Rate Limiter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../routing.html">Routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../session.html">Sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup.html">Installing &amp; Setting up the Symfony Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../serializer.html">How to Use the Serializer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../service_container.html">Service Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../translation.html">Translations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../validation.html">Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../web_link.html">Asset Preloading and Resource Hints with HTTP/2 and WebLink</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflow.html">Workflow</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">The Components</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="using_components.html">How to Install and Use the Symfony Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="asset.html">The Asset Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="browser_kit.html">The BrowserKit Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="cache.html">The Cache Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="config.html">The Config Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="console.html">The Console Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="contracts.html">The Contracts Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="css_selector.html">The CssSelector Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="dependency_injection.html">The DependencyInjection Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="dom_crawler.html">The DomCrawler Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_dispatcher.html">The EventDispatcher Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="expression_language.html">The ExpressionLanguage Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="filesystem.html">The Filesystem Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="finder.html">The Finder Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="form.html">The Form Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="http_foundation.html">The HttpFoundation Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="http_kernel.html">The HttpKernel Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="inflector.html">The Inflector Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="intl.html">The Intl Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="ldap.html">The Ldap Component</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">The Lock Component</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usage">Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#serializing-locks">Serializing Locks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#blocking-locks">Blocking Locks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#expiring-locks">Expiring Locks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shared-locks">Shared Locks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-owner-of-the-lock">The Owner of The Lock</a></li>
<li class="toctree-l3"><a class="reference internal" href="#available-stores">Available Stores</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#flockstore">FlockStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#memcachedstore">MemcachedStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mongodbstore">MongoDbStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pdostore">PdoStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#postgresqlstore">PostgreSqlStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#redisstore">RedisStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#semaphorestore">SemaphoreStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#combinedstore">CombinedStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#zookeeperstore">ZookeeperStore</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#reliability">Reliability</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#remote-stores">Remote Stores</a></li>
<li class="toctree-l4"><a class="reference internal" href="#expiring-stores">Expiring Stores</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">FlockStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">MemcachedStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">MongoDbStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">PdoStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">PostgreSqlStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">RedisStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">CombinedStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">SemaphoreStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">ZookeeperStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#overall">Overall</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="messenger.html">The Messenger Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="mime.html">The Mime Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="options_resolver.html">The OptionsResolver Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="phpunit_bridge.html">The PHPUnit Bridge</a></li>
<li class="toctree-l2"><a class="reference internal" href="process.html">The Process Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="property_access.html">The PropertyAccess Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="property_info.html">The PropertyInfo Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="psr7.html">The PSR-7 Bridge</a></li>
<li class="toctree-l2"><a class="reference internal" href="security.html">The Security Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="semaphore.html">The Semaphore Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="serializer.html">The Serializer Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="string.html">The String Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="uid.html">The UID Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="validator.html">The Validator Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="var_dumper.html">The VarDumper Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="var_exporter.html">The VarExporter Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflow.html">The Workflow Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="yaml.html">The Yaml Component</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference Documents</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../create_framework/index.html">Create your own PHP Framework</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Symfony Framework Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">The Components</a> &raquo;</li>
        
      <li>The Lock Component</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/components/lock.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="the-lock-component">
<span id="index-0"></span><h1>The Lock Component<a class="headerlink" href="#the-lock-component" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div>The Lock Component creates and manages <a class="reference external" href="https://en.wikipedia.org/wiki/Lock_(computer_science)">locks</a>, a mechanism to provide
exclusive access to a shared resource.</div></blockquote>
<p>If you’re using the Symfony Framework, read the
<a class="reference internal" href="../lock.html"><span class="doc">Symfony Framework Lock documentation</span></a>.</p>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> composer require symfony/lock
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you install this component outside of a Symfony application, you must
require the <code class="docutils literal notranslate"><span class="pre">vendor/autoload.php</span></code> file in your code to enable the class
autoloading mechanism provided by Composer. Read
<a class="reference internal" href="using_components.html"><span class="doc">this article</span></a> for more details.</p>
</div>
</div>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>Locks are used to guarantee exclusive access to some shared resource. In
Symfony applications, you can use locks for example to ensure that a command is
not executed more than once at the same time (on the same or different servers).</p>
<p>Locks are created using a <code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Lock/LockFactory.php" title="Symfony\Component\Lock\LockFactory"><span class="pre">LockFactory</span></a></code> class,
which in turn requires another class to manage the storage of locks:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Symfony\Component\Lock\LockFactory</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Lock\Store\SemaphoreStore</span><span class="p">;</span>

<span class="nv">$store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SemaphoreStore</span><span class="p">();</span>
<span class="nv">$factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LockFactory</span><span class="p">(</span><span class="nv">$store</span><span class="p">);</span>
</pre></div>
</div>
<p>The lock is created by calling the <code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Lock/LockFactory.php" title="Symfony\Component\Lock\LockFactory::createLock()"><span class="pre">createLock()</span></a></code>
method. Its first argument is an arbitrary string that represents the locked
resource. Then, a call to the <code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Lock/LockInterface.php" title="Symfony\Component\Lock\LockInterface::acquire()"><span class="pre">acquire()</span></a></code>
method will try to acquire the lock:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// ...</span>
<span class="nv">$lock</span> <span class="o">=</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="na">createLock</span><span class="p">(</span><span class="s1">&#39;pdf-invoice-generation&#39;</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">acquire</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// The resource &quot;pdf-invoice-generation&quot; is locked.</span>
    <span class="c1">// You can compute and generate invoice safely here.</span>

    <span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">release</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If the lock can not be acquired, the method returns <code class="docutils literal notranslate"><span class="pre">false</span></code>. The <code class="docutils literal notranslate"><span class="pre">acquire()</span></code>
method can be safely called repeatedly, even if the lock is already acquired.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Unlike other implementations, the Lock Component distinguishes locks
instances even when they are created for the same resource. If a lock has
to be used by several services, they should share the same <code class="docutils literal notranslate"><span class="pre">Lock</span></code> instance
returned by the <code class="docutils literal notranslate"><span class="pre">LockFactory::createLock</span></code> method.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">If you don’t release the lock explicitly, it will be released automatically
on instance destruction. In some cases, it can be useful to lock a resource
across several requests. To disable the automatic release behavior, set the
third argument of the <code class="docutils literal notranslate"><span class="pre">createLock()</span></code> method to <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
</div>
</div>
<div class="section" id="serializing-locks">
<h2>Serializing Locks<a class="headerlink" href="#serializing-locks" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Key</span></code> contains the state of the <code class="docutils literal notranslate"><span class="pre">Lock</span></code> and can be serialized. This
allows the user to begin a long job in a process by acquiring the lock, and
continue the job in an other process using the same lock:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Symfony\Component\Lock\Key</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Lock\Lock</span><span class="p">;</span>

<span class="nv">$key</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Key</span><span class="p">(</span><span class="s1">&#39;article.&#39;</span><span class="o">.</span><span class="nv">$article</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">());</span>
<span class="nv">$lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Lock</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">store</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
<span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">acquire</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bus</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">RefreshTaxonomy</span><span class="p">(</span><span class="nv">$article</span><span class="p">,</span> <span class="nv">$key</span><span class="p">));</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Don’t forget to disable the autoRelease to avoid releasing the lock when
the destructor is called.</p>
</div>
<p>Not all stores are compatible with serialization and cross-process locking:
for example, the kernel will automatically release semaphores acquired by the
<a class="reference internal" href="#lock-store-semaphore"><span class="std std-ref">SemaphoreStore</span></a> store. If you use an incompatible
store, an exception will be thrown when the application tries to serialize the key.</p>
</div>
<div class="section" id="blocking-locks">
<span id="lock-blocking-locks"></span><h2>Blocking Locks<a class="headerlink" href="#blocking-locks" title="Permalink to this headline">¶</a></h2>
<p>By default, when a lock cannot be acquired, the <code class="docutils literal notranslate"><span class="pre">acquire</span></code> method returns
<code class="docutils literal notranslate"><span class="pre">false</span></code> immediately. To wait (indefinitely) until the lock
can be created, pass <code class="docutils literal notranslate"><span class="pre">true</span></code> as the argument of the <code class="docutils literal notranslate"><span class="pre">acquire()</span></code> method. This
is called a <strong>blocking lock</strong> because the execution of your application stops
until the lock is acquired.</p>
<p>Some of the built-in <code class="docutils literal notranslate"><span class="pre">Store</span></code> classes support this feature. When they don’t,
they can be decorated with the <code class="docutils literal notranslate"><span class="pre">RetryTillSaveStore</span></code> class:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Symfony\Component\Lock\LockFactory</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Lock\Store\RedisStore</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Lock\Store\RetryTillSaveStore</span><span class="p">;</span>

<span class="nv">$store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RedisStore</span><span class="p">(</span><span class="k">new</span> <span class="nx">\Predis\Client</span><span class="p">(</span><span class="s1">&#39;tcp://localhost:6379&#39;</span><span class="p">));</span>
<span class="nv">$store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RetryTillSaveStore</span><span class="p">(</span><span class="nv">$store</span><span class="p">);</span>
<span class="nv">$factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LockFactory</span><span class="p">(</span><span class="nv">$store</span><span class="p">);</span>

<span class="nv">$lock</span> <span class="o">=</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="na">createLock</span><span class="p">(</span><span class="s1">&#39;notification-flush&#39;</span><span class="p">);</span>
<span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">acquire</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</pre></div>
</div>
<p>When the provided store does not implement the
<code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Lock/BlockingStoreInterface.php" title="Symfony\Component\Lock\BlockingStoreInterface"><span class="pre">BlockingStoreInterface</span></a></code> interface, the
<code class="docutils literal notranslate"><span class="pre">Lock</span></code> class will retry to acquire the lock in a non-blocking way until the
lock is acquired.</p>
<div class="deprecated">
<p><span class="versionmodified">Deprecated since version 5.2: </span>As of Symfony 5.2, you don’t need to use the <code class="docutils literal notranslate"><span class="pre">RetryTillSaveStore</span></code> class
anymore. The <code class="docutils literal notranslate"><span class="pre">Lock</span></code> class now provides the default logic to acquire locks
in blocking mode when the store does not implement the
<code class="docutils literal notranslate"><span class="pre">BlockingStoreInterface</span></code> interface.</p>
</div>
</div>
<div class="section" id="expiring-locks">
<h2>Expiring Locks<a class="headerlink" href="#expiring-locks" title="Permalink to this headline">¶</a></h2>
<p>Locks created remotely are difficult to manage because there is no way for the
remote <code class="docutils literal notranslate"><span class="pre">Store</span></code> to know if the locker process is still alive. Due to bugs,
fatal errors or segmentation faults, it cannot be guaranteed that <code class="docutils literal notranslate"><span class="pre">release()</span></code>
method will be called, which would cause the resource to be locked infinitely.</p>
<p>The best solution in those cases is to create <strong>expiring locks</strong>, which are
released automatically after some amount of time has passed (called TTL for
<em>Time To Live</em>). This time, in seconds, is configured as the second argument of
the <code class="docutils literal notranslate"><span class="pre">createLock()</span></code> method. If needed, these locks can also be released early
with the <code class="docutils literal notranslate"><span class="pre">release()</span></code> method.</p>
<p>The trickiest part when working with expiring locks is choosing the right TTL.
If it’s too short, other processes could acquire the lock before finishing the
job; if it’s too long and the process crashes before calling the <code class="docutils literal notranslate"><span class="pre">release()</span></code>
method, the resource will stay locked until the timeout:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// ...</span>
<span class="c1">// create an expiring lock that lasts 30 seconds</span>
<span class="nv">$lock</span> <span class="o">=</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="na">createLock</span><span class="p">(</span><span class="s1">&#39;charts-generation&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">acquire</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="c1">// perform a job during less than 30 seconds</span>
<span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
    <span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">release</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">To avoid letting the lock in a locking state, it’s recommended to wrap the
job in a try/catch/finally block to always try to release the expiring lock.</p>
</div>
<p>In case of long-running tasks, it’s better to start with a not too long TTL and
then use the <code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Lock/LockInterface.php" title="Symfony\Component\Lock\LockInterface::refresh()"><span class="pre">refresh()</span></a></code> method
to reset the TTL to its original value:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// ...</span>
<span class="nv">$lock</span> <span class="o">=</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="na">createLock</span><span class="p">(</span><span class="s1">&#39;charts-generation&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">acquire</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nv">$finished</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// perform a small part of the job.</span>

        <span class="c1">// renew the lock for 30 more seconds.</span>
        <span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">refresh</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
    <span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">release</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Another useful technique for long-running tasks is to pass a custom TTL as
an argument of the <code class="docutils literal notranslate"><span class="pre">refresh()</span></code> method to change the default lock TTL:</p>
<div class="last highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$lock</span> <span class="o">=</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="na">createLock</span><span class="p">(</span><span class="s1">&#39;charts-generation&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
<span class="c1">// ...</span>
<span class="c1">// refresh the lock for 30 seconds</span>
<span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">refresh</span><span class="p">();</span>
<span class="c1">// ...</span>
<span class="c1">// refresh the lock for 600 seconds (next refresh() call will be 30 seconds again)</span>
<span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">refresh</span><span class="p">(</span><span class="mi">600</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>This component also provides two useful methods related to expiring locks:
<code class="docutils literal notranslate"><span class="pre">getRemainingLifetime()</span></code> (which returns <code class="docutils literal notranslate"><span class="pre">null</span></code> or a <code class="docutils literal notranslate"><span class="pre">float</span></code>
as seconds) and <code class="docutils literal notranslate"><span class="pre">isExpired()</span></code> (which returns a boolean).</p>
</div>
<div class="section" id="shared-locks">
<h2>Shared Locks<a class="headerlink" href="#shared-locks" title="Permalink to this headline">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified">New in version 5.2: </span>Shared locks (and the associated <code class="docutils literal notranslate"><span class="pre">acquireRead()</span></code> method and
<code class="docutils literal notranslate"><span class="pre">SharedLockStoreInterface</span></code>) were introduced in Symfony 5.2.</p>
</div>
<p>A shared or <a class="reference external" href="https://en.wikipedia.org/wiki/Readers%E2%80%93writer_lock">readers–writer lock</a> is a synchronization primitive that allows
concurrent access for read-only operations, while write operations require
exclusive access. This means that multiple threads can read the data in parallel
but an exclusive lock is needed for writing or modifying data. They are used for
example for data structures that cannot be updated atomically and are invalid
until the update is complete.</p>
<p>Use the <code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Lock/SharedLockInterface.php" title="Symfony\Component\Lock\SharedLockInterface::acquireRead()"><span class="pre">acquireRead()</span></a></code> method
to acquire a read-only lock, and the existing
<code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Lock/LockInterface.php" title="Symfony\Component\Lock\LockInterface::acquire()"><span class="pre">acquire()</span></a></code> method to acquire a
write lock:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$lock</span> <span class="o">=</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="na">createLock</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="o">.</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">acquireRead</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Similar to the <code class="docutils literal notranslate"><span class="pre">acquire()</span></code> method, pass <code class="docutils literal notranslate"><span class="pre">true</span></code> as the argument of <code class="docutils literal notranslate"><span class="pre">acquireRead()</span></code>
to acquire the lock in a blocking mode:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$lock</span> <span class="o">=</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="na">createLock</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="o">.</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">acquireRead</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <a class="reference external" href="https://en.wikipedia.org/wiki/Readers%E2%80%93writer_lock#Priority_policies">priority policy</a> of Symfony’s shared locks depends on the underlying
store (e.g. Redis store prioritizes readers vs writers).</p>
</div>
<p>When a read-only lock is acquired with the method <code class="docutils literal notranslate"><span class="pre">acquireRead()</span></code>, it’s
possible to <strong>promote</strong> the lock, and change it to write lock, by calling the
<code class="docutils literal notranslate"><span class="pre">acquire()</span></code> method:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$lock</span> <span class="o">=</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="na">createLock</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="o">.</span><span class="nv">$userId</span><span class="p">);</span>
<span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">acquireRead</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shouldUpdate</span><span class="p">(</span><span class="nv">$userId</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">acquire</span><span class="p">(</span><span class="k">true</span><span class="p">);</span> <span class="c1">// Promote the lock to write lock</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="nv">$userId</span><span class="p">);</span>
</pre></div>
</div>
<p>In the same way, it’s possible to <strong>demote</strong> a write lock, and change it to a
read-only lock by calling the <code class="docutils literal notranslate"><span class="pre">acquireRead()</span></code> method.</p>
<p>When the provided store does not implement the
<code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Lock/SharedLockStoreInterface.php" title="Symfony\Component\Lock\SharedLockStoreInterface"><span class="pre">SharedLockStoreInterface</span></a></code> interface, the
<code class="docutils literal notranslate"><span class="pre">Lock</span></code> class will fallback to a write lock by calling the <code class="docutils literal notranslate"><span class="pre">acquire()</span></code> method.</p>
</div>
<div class="section" id="the-owner-of-the-lock">
<h2>The Owner of The Lock<a class="headerlink" href="#the-owner-of-the-lock" title="Permalink to this headline">¶</a></h2>
<p>Locks that are acquired for the first time are owned <a class="footnote-reference" href="#id2" id="id1">[1]</a> by the <code class="docutils literal notranslate"><span class="pre">Lock</span></code> instance that acquired
it. If you need to check whether the current <code class="docutils literal notranslate"><span class="pre">Lock</span></code> instance is (still) the owner of
a lock, you can use the <code class="docutils literal notranslate"><span class="pre">isAcquired()</span></code> method:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">isAcquired</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// We (still) own the lock</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Because of the fact that some lock stores have expiring locks (as seen and explained
above), it is possible for an instance to lose the lock it acquired automatically:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// If we cannot acquire ourselves, it means some other process is already working on it</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">acquire</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>

<span class="c1">// Perform a very long process that might exceed TTL of the lock</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">isAcquired</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// Still all good, no other instance has acquired the lock in the meantime, we&#39;re safe</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Bummer! Our lock has apparently exceeded TTL and another process has started in</span>
    <span class="c1">// the meantime so it&#39;s not safe for us to commit.</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rollback</span><span class="p">();</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s1">&#39;Process failed&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">A common pitfall might be to use the <code class="docutils literal notranslate"><span class="pre">isAcquired()</span></code> method to check if
a lock has already been acquired by any process. As you can see in this example
you have to use <code class="docutils literal notranslate"><span class="pre">acquire()</span></code> for this. The <code class="docutils literal notranslate"><span class="pre">isAcquired()</span></code> method is used to check
if the lock has been acquired by the <strong>current process</strong> only!</p>
</div>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Technically, the true owners of the lock are the ones that share the same instance of <code class="docutils literal notranslate"><span class="pre">Key</span></code>,
not <code class="docutils literal notranslate"><span class="pre">Lock</span></code>. But from a user perspective, <code class="docutils literal notranslate"><span class="pre">Key</span></code> is internal and you will likely only be working
with the <code class="docutils literal notranslate"><span class="pre">Lock</span></code> instance so it’s easier to think of the <code class="docutils literal notranslate"><span class="pre">Lock</span></code> instance as being the one that
is the owner of the lock.</td></tr>
</tbody>
</table>
</div>
<div class="section" id="available-stores">
<h2>Available Stores<a class="headerlink" href="#available-stores" title="Permalink to this headline">¶</a></h2>
<p>Locks are created and managed in <code class="docutils literal notranslate"><span class="pre">Stores</span></code>, which are classes that implement
<code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Lock/PersistingStoreInterface.php" title="Symfony\Component\Lock\PersistingStoreInterface"><span class="pre">PersistingStoreInterface</span></a></code> and, optionally,
<code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Lock/BlockingStoreInterface.php" title="Symfony\Component\Lock\BlockingStoreInterface"><span class="pre">BlockingStoreInterface</span></a></code>.</p>
<p>The component includes the following built-in store types:</p>
<table border="1" class="docutils">
<colgroup>
<col width="60%" />
<col width="8%" />
<col width="11%" />
<col width="11%" />
<col width="10%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Store</th>
<th class="head">Scope</th>
<th class="head">Blocking</th>
<th class="head">Expiring</th>
<th class="head">Sharing</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><a class="reference internal" href="#lock-store-flock"><span class="std std-ref">FlockStore</span></a></td>
<td>local</td>
<td>yes</td>
<td>no</td>
<td>yes</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#lock-store-memcached"><span class="std std-ref">MemcachedStore</span></a></td>
<td>remote</td>
<td>no</td>
<td>yes</td>
<td>no</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#lock-store-mongodb"><span class="std std-ref">MongoDbStore</span></a></td>
<td>remote</td>
<td>no</td>
<td>yes</td>
<td>no</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#lock-store-pdo"><span class="std std-ref">PdoStore</span></a></td>
<td>remote</td>
<td>no</td>
<td>yes</td>
<td>no</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#lock-store-pgsql"><span class="std std-ref">PostgreSqlStore</span></a></td>
<td>remote</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#lock-store-redis"><span class="std std-ref">RedisStore</span></a></td>
<td>remote</td>
<td>no</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#lock-store-semaphore"><span class="std std-ref">SemaphoreStore</span></a></td>
<td>local</td>
<td>yes</td>
<td>no</td>
<td>no</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#lock-store-zookeeper"><span class="std std-ref">ZookeeperStore</span></a></td>
<td>remote</td>
<td>no</td>
<td>no</td>
<td>no</td>
</tr>
</tbody>
</table>
<div class="section" id="flockstore">
<span id="lock-store-flock"></span><h3>FlockStore<a class="headerlink" href="#flockstore" title="Permalink to this headline">¶</a></h3>
<p>The FlockStore uses the file system on the local computer to create the locks.
It does not support expiration, but the lock is automatically released when the
lock object goes out of scope and is freed by the garbage collector (for example
when the PHP process ends):</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Symfony\Component\Lock\Store\FlockStore</span><span class="p">;</span>

<span class="c1">// the argument is the path of the directory where the locks are created</span>
<span class="c1">// if none is given, sys_get_temp_dir() is used internally.</span>
<span class="nv">$store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FlockStore</span><span class="p">(</span><span class="s1">&#39;/var/stores&#39;</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Beware that some file systems (such as some types of NFS) do not support
locking. In those cases, it’s better to use a directory on a local disk
drive or a remote store based on PDO, Redis or Memcached.</p>
</div>
</div>
<div class="section" id="memcachedstore">
<span id="lock-store-memcached"></span><h3>MemcachedStore<a class="headerlink" href="#memcachedstore" title="Permalink to this headline">¶</a></h3>
<p>The MemcachedStore saves locks on a Memcached server, it requires a Memcached
connection implementing the <code class="docutils literal notranslate"><span class="pre">\Memcached</span></code> class. This store does not
support blocking, and expects a TTL to avoid stalled locks:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Symfony\Component\Lock\Store\MemcachedStore</span><span class="p">;</span>

<span class="nv">$memcached</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Memcached</span><span class="p">();</span>
<span class="nv">$memcached</span><span class="o">-&gt;</span><span class="na">addServer</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">11211</span><span class="p">);</span>

<span class="nv">$store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MemcachedStore</span><span class="p">(</span><span class="nv">$memcached</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Memcached does not support TTL lower than 1 second.</p>
</div>
</div>
<div class="section" id="mongodbstore">
<span id="lock-store-mongodb"></span><h3>MongoDbStore<a class="headerlink" href="#mongodbstore" title="Permalink to this headline">¶</a></h3>
<div class="versionadded">
<p><span class="versionmodified">New in version 5.1: </span>The <code class="docutils literal notranslate"><span class="pre">MongoDbStore</span></code> was introduced in Symfony 5.1.</p>
</div>
<p>The MongoDbStore saves locks on a MongoDB server <code class="docutils literal notranslate"><span class="pre">&gt;=2.2</span></code>, it requires a
<code class="docutils literal notranslate"><span class="pre">\MongoDB\Collection</span></code> or <code class="docutils literal notranslate"><span class="pre">\MongoDB\Client</span></code> from <a class="reference external" href="https://packagist.org/packages/mongodb/mongodb">mongodb/mongodb</a> or a
<a class="reference external" href="https://docs.mongodb.com/manual/reference/connection-string/">MongoDB Connection String</a>.
This store does not support blocking and expects a TTL to
avoid stalled locks:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Symfony\Component\Lock\Store\MongoDbStore</span><span class="p">;</span>

<span class="nv">$mongo</span> <span class="o">=</span> <span class="s1">&#39;mongodb://localhost/database?collection=lock&#39;</span><span class="p">;</span>
<span class="nv">$options</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;gcProbablity&#39;</span> <span class="o">=&gt;</span> <span class="mf">0.001</span><span class="p">,</span>
    <span class="s1">&#39;database&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;myapp&#39;</span><span class="p">,</span>
    <span class="s1">&#39;collection&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;lock&#39;</span><span class="p">,</span>
    <span class="s1">&#39;uriOptions&#39;</span> <span class="o">=&gt;</span> <span class="p">[],</span>
    <span class="s1">&#39;driverOptions&#39;</span> <span class="o">=&gt;</span> <span class="p">[],</span>
<span class="p">];</span>
<span class="nv">$store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MongoDbStore</span><span class="p">(</span><span class="nv">$mongo</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">MongoDbStore</span></code> takes the following <code class="docutils literal notranslate"><span class="pre">$options</span></code> (depending on the first parameter type):</p>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>gcProbablity</td>
<td>Should a TTL Index be created expressed as a probability from 0.0 to 1.0 (Defaults to <code class="docutils literal notranslate"><span class="pre">0.001</span></code>)</td>
</tr>
<tr class="row-odd"><td>database</td>
<td>The name of the database</td>
</tr>
<tr class="row-even"><td>collection</td>
<td>The name of the collection</td>
</tr>
<tr class="row-odd"><td>uriOptions</td>
<td>Array of uri options for <a class="reference external" href="https://docs.mongodb.com/php-library/current/reference/method/MongoDBClient__construct/">MongoDBClient::__construct</a></td>
</tr>
<tr class="row-even"><td>driverOptions</td>
<td>Array of driver options for <a class="reference external" href="https://docs.mongodb.com/php-library/current/reference/method/MongoDBClient__construct/">MongoDBClient::__construct</a></td>
</tr>
</tbody>
</table>
<p>When the first parameter is a:</p>
<p><code class="docutils literal notranslate"><span class="pre">MongoDB\Collection</span></code>:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">$options['database']</span></code> is ignored</li>
<li><code class="docutils literal notranslate"><span class="pre">$options['collection']</span></code> is ignored</li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">MongoDB\Client</span></code>:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">$options['database']</span></code> is mandatory</li>
<li><code class="docutils literal notranslate"><span class="pre">$options['collection']</span></code> is mandatory</li>
</ul>
<p>MongoDB Connection String:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">$options['database']</span></code> is used otherwise <code class="docutils literal notranslate"><span class="pre">/path</span></code> from the DSN, at least one is mandatory</li>
<li><code class="docutils literal notranslate"><span class="pre">$options['collection']</span></code> is used otherwise <code class="docutils literal notranslate"><span class="pre">?collection=</span></code> from the DSN, at least one is mandatory</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">collection</span></code> querystring parameter is not part of the <a class="reference external" href="https://docs.mongodb.com/manual/reference/connection-string/">MongoDB Connection String</a> definition.
It is used to allow constructing a <code class="docutils literal notranslate"><span class="pre">MongoDbStore</span></code> using a <a class="reference external" href="https://en.wikipedia.org/wiki/Data_source_name">Data Source Name (DSN)</a> without <code class="docutils literal notranslate"><span class="pre">$options</span></code>.</p>
</div>
</div>
<div class="section" id="pdostore">
<span id="lock-store-pdo"></span><h3>PdoStore<a class="headerlink" href="#pdostore" title="Permalink to this headline">¶</a></h3>
<p>The PdoStore saves locks in an SQL database. It requires a <a class="reference external" href="https://www.php.net/pdo">PDO</a> connection, a
<a class="reference external" href="https://github.com/doctrine/dbal/blob/master/src/Connection.php">Doctrine DBAL Connection</a>, or a <a class="reference external" href="https://en.wikipedia.org/wiki/Data_source_name">Data Source Name (DSN)</a>. This store does not
support blocking, and expects a TTL to avoid stalled locks:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Symfony\Component\Lock\Store\PdoStore</span><span class="p">;</span>

<span class="c1">// a PDO, a Doctrine DBAL connection or DSN for lazy connecting through PDO</span>
<span class="nv">$databaseConnectionOrDSN</span> <span class="o">=</span> <span class="s1">&#39;mysql:host=127.0.0.1;dbname=app&#39;</span><span class="p">;</span>
<span class="nv">$store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PdoStore</span><span class="p">(</span><span class="nv">$databaseConnectionOrDSN</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;db_username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;myuser&#39;</span><span class="p">,</span> <span class="s1">&#39;db_password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;mypassword&#39;</span><span class="p">]);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This store does not support TTL lower than 1 second.</p>
</div>
<p>The table where values are stored is created automatically on the first call to
the <code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Lock/Store/PdoStore.php" title="Symfony\Component\Lock\Store\PdoStore::save()"><span class="pre">save()</span></a></code> method.
You can also create this table explicitly by calling the
<code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Lock/Store/PdoStore.php" title="Symfony\Component\Lock\Store\PdoStore::createTable()"><span class="pre">createTable()</span></a></code> method in
your code.</p>
</div>
<div class="section" id="postgresqlstore">
<span id="lock-store-pgsql"></span><h3>PostgreSqlStore<a class="headerlink" href="#postgresqlstore" title="Permalink to this headline">¶</a></h3>
<p>The PostgreSqlStore uses <a class="reference external" href="https://www.postgresql.org/docs/current/explicit-locking.html">Advisory Locks</a> provided by PostgreSQL. It requires a
<a class="reference external" href="https://www.php.net/pdo">PDO</a> connection, a <a class="reference external" href="https://github.com/doctrine/dbal/blob/master/src/Connection.php">Doctrine DBAL Connection</a>, or a
<a class="reference external" href="https://en.wikipedia.org/wiki/Data_source_name">Data Source Name (DSN)</a>. It supports native blocking, as well as sharing locks.</p>
<blockquote>
<div><p>use SymfonyComponentLockStorePostgreSqlStore;</p>
<p>// a PDO, a Doctrine DBAL connection or DSN for lazy connecting through PDO
$databaseConnectionOrDSN = ‘postgresql://myuser:mypassword&#64;localhost:5634/lock’;
$store = new PostgreSqlStore($databaseConnectionOrDSN);</p>
</div></blockquote>
<p>In opposite to the <code class="docutils literal notranslate"><span class="pre">PdoStore</span></code>, the <code class="docutils literal notranslate"><span class="pre">PostgreSqlStore</span></code> does not need a table to
store locks and does not expire.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 5.2: </span>The <code class="docutils literal notranslate"><span class="pre">PostgreSqlStore</span></code> was introduced in Symfony 5.2.</p>
</div>
</div>
<div class="section" id="redisstore">
<span id="lock-store-redis"></span><h3>RedisStore<a class="headerlink" href="#redisstore" title="Permalink to this headline">¶</a></h3>
<p>The RedisStore saves locks on a Redis server, it requires a Redis connection
implementing the <code class="docutils literal notranslate"><span class="pre">\Redis</span></code>, <code class="docutils literal notranslate"><span class="pre">\RedisArray</span></code>, <code class="docutils literal notranslate"><span class="pre">\RedisCluster</span></code> or
<code class="docutils literal notranslate"><span class="pre">\Predis</span></code> classes. This store does not support blocking, and expects a TTL to
avoid stalled locks:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Symfony\Component\Lock\Store\RedisStore</span><span class="p">;</span>

<span class="nv">$redis</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Redis</span><span class="p">();</span>
<span class="nv">$redis</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">);</span>

<span class="nv">$store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RedisStore</span><span class="p">(</span><span class="nv">$redis</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="semaphorestore">
<span id="lock-store-semaphore"></span><h3>SemaphoreStore<a class="headerlink" href="#semaphorestore" title="Permalink to this headline">¶</a></h3>
<p>The SemaphoreStore uses the <a class="reference external" href="https://www.php.net/manual/en/book.sem.php">PHP semaphore functions</a> to create the locks:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Symfony\Component\Lock\Store\SemaphoreStore</span><span class="p">;</span>

<span class="nv">$store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SemaphoreStore</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="combinedstore">
<span id="lock-store-combined"></span><h3>CombinedStore<a class="headerlink" href="#combinedstore" title="Permalink to this headline">¶</a></h3>
<p>The CombinedStore is designed for High Availability applications because it
manages several stores in sync (for example, several Redis servers). When a lock
is being acquired, it forwards the call to all the managed stores, and it
collects their responses. If a simple majority of stores have acquired the lock,
then the lock is considered as acquired; otherwise as not acquired:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Symfony\Component\Lock\Store\CombinedStore</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Lock\Store\RedisStore</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Lock\Strategy\ConsensusStrategy</span><span class="p">;</span>

<span class="nv">$stores</span> <span class="o">=</span> <span class="p">[];</span>
<span class="k">foreach</span> <span class="p">([</span><span class="s1">&#39;server1&#39;</span><span class="p">,</span> <span class="s1">&#39;server2&#39;</span><span class="p">,</span> <span class="s1">&#39;server3&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$server</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$redis</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Redis</span><span class="p">();</span>
    <span class="nv">$redis</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span><span class="nv">$server</span><span class="p">);</span>

    <span class="nv">$stores</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RedisStore</span><span class="p">(</span><span class="nv">$redis</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CombinedStore</span><span class="p">(</span><span class="nv">$stores</span><span class="p">,</span> <span class="k">new</span> <span class="nx">ConsensusStrategy</span><span class="p">());</span>
</pre></div>
</div>
<p>Instead of the simple majority strategy (<code class="docutils literal notranslate"><span class="pre">ConsensusStrategy</span></code>) an
<code class="docutils literal notranslate"><span class="pre">UnanimousStrategy</span></code> can be used to require the lock to be acquired in all
the stores.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">In order to get high availability when using the <code class="docutils literal notranslate"><span class="pre">ConsensusStrategy</span></code>, the
minimum cluster size must be three servers. This allows the cluster to keep
working when a single server fails (because this strategy requires that the
lock is acquired in more than half of the servers).</p>
</div>
</div>
<div class="section" id="zookeeperstore">
<span id="lock-store-zookeeper"></span><h3>ZookeeperStore<a class="headerlink" href="#zookeeperstore" title="Permalink to this headline">¶</a></h3>
<p>The ZookeeperStore saves locks on a <a class="reference external" href="https://zookeeper.apache.org/">ZooKeeper</a> server. It requires a ZooKeeper
connection implementing the <code class="docutils literal notranslate"><span class="pre">\Zookeeper</span></code> class. This store does not
support blocking and expiration but the lock is automatically released when the
PHP process is terminated:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Symfony\Component\Lock\Store\ZookeeperStore</span><span class="p">;</span>

<span class="nv">$zookeeper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Zookeeper</span><span class="p">(</span><span class="s1">&#39;localhost:2181&#39;</span><span class="p">);</span>
<span class="c1">// use the following to define a high-availability cluster:</span>
<span class="c1">// $zookeeper = new \Zookeeper(&#39;localhost1:2181,localhost2:2181,localhost3:2181&#39;);</span>

<span class="nv">$store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZookeeperStore</span><span class="p">(</span><span class="nv">$zookeeper</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Zookeeper does not require a TTL as the nodes used for locking are ephemeral
and die when the PHP process is terminated.</p>
</div>
</div>
</div>
<div class="section" id="reliability">
<h2>Reliability<a class="headerlink" href="#reliability" title="Permalink to this headline">¶</a></h2>
<p>The component guarantees that the same resource can’t be lock twice as long as
the component is used in the following way.</p>
<div class="section" id="remote-stores">
<h3>Remote Stores<a class="headerlink" href="#remote-stores" title="Permalink to this headline">¶</a></h3>
<p>Remote stores (<a class="reference internal" href="#lock-store-memcached"><span class="std std-ref">MemcachedStore</span></a>,
<a class="reference internal" href="#lock-store-mongodb"><span class="std std-ref">MongoDbStore</span></a>,
<a class="reference internal" href="#lock-store-pdo"><span class="std std-ref">PdoStore</span></a>,
<a class="reference internal" href="#lock-store-pgsql"><span class="std std-ref">PostgreSqlStore</span></a>,
<a class="reference internal" href="#lock-store-redis"><span class="std std-ref">RedisStore</span></a> and
<a class="reference internal" href="#lock-store-zookeeper"><span class="std std-ref">ZookeeperStore</span></a>) use a unique token to recognize
the true owner of the lock. This token is stored in the
<code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Lock/Key.php" title="Symfony\Component\Lock\Key"><span class="pre">Key</span></a></code> object and is used internally by
the <code class="docutils literal notranslate"><span class="pre">Lock</span></code>, therefore this key must not be shared between processes (session,
caching, fork, …).</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Do not share a key between processes.</p>
</div>
<p>Every concurrent process must store the <code class="docutils literal notranslate"><span class="pre">Lock</span></code> in the same server. Otherwise two
different machines may allow two different processes to acquire the same <code class="docutils literal notranslate"><span class="pre">Lock</span></code>.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">To guarantee that the same server will always be safe, do not use Memcached
behind a LoadBalancer, a cluster or round-robin DNS. Even if the main server
is down, the calls must not be forwarded to a backup or failover server.</p>
</div>
</div>
<div class="section" id="expiring-stores">
<h3>Expiring Stores<a class="headerlink" href="#expiring-stores" title="Permalink to this headline">¶</a></h3>
<p>Expiring stores (<a class="reference internal" href="#lock-store-memcached"><span class="std std-ref">MemcachedStore</span></a>,
<a class="reference internal" href="#lock-store-mongodb"><span class="std std-ref">MongoDbStore</span></a>,
<a class="reference internal" href="#lock-store-pdo"><span class="std std-ref">PdoStore</span></a> and
<a class="reference internal" href="#lock-store-redis"><span class="std std-ref">RedisStore</span></a>)
guarantee that the lock is acquired only for the defined duration of time. If
the task takes longer to be accomplished, then the lock can be released by the
store and acquired by someone else.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Lock</span></code> provides several methods to check its health. The <code class="docutils literal notranslate"><span class="pre">isExpired()</span></code>
method checks whether or not its lifetime is over and the <code class="docutils literal notranslate"><span class="pre">getRemainingLifetime()</span></code>
method returns its time to live in seconds.</p>
<p>Using the above methods, a more robust code would be:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// ...</span>
<span class="nv">$lock</span> <span class="o">=</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="na">createLock</span><span class="p">(</span><span class="s1">&#39;invoice-publication&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">acquire</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nv">$finished</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">getRemainingLifetime</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">isExpired</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// lock was lost, perform a rollback or send a notification</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\RuntimeException</span><span class="p">(</span><span class="s1">&#39;Lock lost during the overall process&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$lock</span><span class="o">-&gt;</span><span class="na">refresh</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// Perform the task whose duration MUST be less than 5 minutes</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Choose wisely the lifetime of the <code class="docutils literal notranslate"><span class="pre">Lock</span></code> and check whether its remaining
time to live is enough to perform the task.</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Storing a <code class="docutils literal notranslate"><span class="pre">Lock</span></code> usually takes a few milliseconds, but network conditions
may increase that time a lot (up to a few seconds). Take that into account
when choosing the right TTL.</p>
</div>
<p>By design, locks are stored in servers with a defined lifetime. If the date or
time of the machine changes, a lock could be released sooner than expected.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">To guarantee that date won’t change, the NTP service should be disabled
and the date should be updated when the service is stopped.</p>
</div>
</div>
<div class="section" id="id3">
<h3>FlockStore<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>By using the file system, this <code class="docutils literal notranslate"><span class="pre">Store</span></code> is reliable as long as concurrent
processes use the same physical directory to stores locks.</p>
<p>Processes must run on the same machine, virtual machine or container.
Be careful when updating a Kubernetes or Swarm service because for a short
period of time, there can be two running containers in parallel.</p>
<p>The absolute path to the directory must remain the same. Be careful of symlinks
that could change at anytime: Capistrano and blue/green deployment often use
that trick. Be careful when the path to that directory changes between two
deployments.</p>
<p>Some file systems (such as some types of NFS) do not support locking.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p>All concurrent processes must use the same physical file system by running
on the same machine and using the same absolute path to locks directory.</p>
<p class="last">By definition, usage of <code class="docutils literal notranslate"><span class="pre">FlockStore</span></code> in an HTTP context is incompatible
with multiple front servers, unless to ensure that the same resource will
always be locked on the same machine or to use a well configured shared file
system.</p>
</div>
<p>Files on the file system can be removed during a maintenance operation. For instance,
to clean up the <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> directory or after a reboot of the machine when a directory
uses tmpfs. It’s not an issue if the lock is released when the process ended, but
it is in case of <code class="docutils literal notranslate"><span class="pre">Lock</span></code> reused between requests.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Do not store locks on a volatile file system if they have to be reused in
several requests.</p>
</div>
</div>
<div class="section" id="id4">
<h3>MemcachedStore<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>The way Memcached works is to store items in memory. That means that by using
the <a class="reference internal" href="#lock-store-memcached"><span class="std std-ref">MemcachedStore</span></a> the locks are not persisted
and may disappear by mistake at anytime.</p>
<p>If the Memcached service or the machine hosting it restarts, every lock would
be lost without notifying the running processes.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">To avoid that someone else acquires a lock after a restart, it’s recommended
to delay service start and wait at least as long as the longest lock TTL.</p>
</div>
<p>By default Memcached uses a LRU mechanism to remove old entries when the service
needs space to add new items.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">The number of items stored in Memcached must be under control. If it’s not
possible, LRU should be disabled and Lock should be stored in a dedicated
Memcached service away from Cache.</p>
</div>
<p>When the Memcached service is shared and used for multiple usage, Locks could be
removed by mistake. For instance some implementation of the PSR-6 <code class="docutils literal notranslate"><span class="pre">clear()</span></code>
method uses the Memcached’s <code class="docutils literal notranslate"><span class="pre">flush()</span></code> method which purges and removes everything.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">The method <code class="docutils literal notranslate"><span class="pre">flush()</span></code> must not be called, or locks should be stored in a
dedicated Memcached service away from Cache.</p>
</div>
</div>
<div class="section" id="id5">
<h3>MongoDbStore<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">The locked resource name is indexed in the <code class="docutils literal notranslate"><span class="pre">_id</span></code> field of the lock
collection. Beware that in MongoDB an indexed field’s value can be
<a class="reference external" href="https://docs.mongodb.com/manual/reference/limits/#Index-Key-Limit">a maximum of 1024 bytes in length</a> inclusive of structural overhead.</p>
</div>
<p>A TTL index must be used to automatically clean up expired locks.
Such an index can be created manually:</p>
<div class="highlight-javascript notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nx">ensureIndex</span><span class="p">(</span>
    <span class="p">{</span> <span class="s2">&quot;expires_at&quot;</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s2">&quot;expireAfterSeconds&quot;</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Alternatively, the method <code class="docutils literal notranslate"><span class="pre">MongoDbStore::createTtlIndex(int</span> <span class="pre">$expireAfterSeconds</span> <span class="pre">=</span> <span class="pre">0)</span></code>
can be called once to create the TTL index during database setup. Read more
about <a class="reference external" href="https://docs.mongodb.com/manual/tutorial/expire-data/">Expire Data from Collections by Setting TTL</a> in MongoDB.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">MongoDbStore</span></code> will attempt to automatically create a TTL index.
It’s recommended to set constructor option <code class="docutils literal notranslate"><span class="pre">gcProbablity</span> <span class="pre">=</span> <span class="pre">0.0</span></code> to
disable this behavior if you have manually dealt with TTL index creation.</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">This store relies on all PHP application and database nodes to have
synchronized clocks for lock expiry to occur at the correct time. To ensure
locks don’t expire prematurely; the lock TTL should be set with enough extra
time in <code class="docutils literal notranslate"><span class="pre">expireAfterSeconds</span></code> to account for any clock drift between nodes.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">writeConcern</span></code>, <code class="docutils literal notranslate"><span class="pre">readConcern</span></code> and <code class="docutils literal notranslate"><span class="pre">readPreference</span></code> are not specified by
MongoDbStore meaning the collection’s settings will take effect. Read more
about <a class="reference external" href="https://docs.mongodb.com/manual/applications/replication/">Replica Set Read and Write Semantics</a> in MongoDB.</p>
</div>
<div class="section" id="id6">
<h3>PdoStore<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>The PdoStore relies on the <a class="reference external" href="https://en.wikipedia.org/wiki/ACID">ACID</a> properties of the SQL engine.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">In a cluster configured with multiple primaries, ensure writes are
synchronously propagated to every nodes, or always use the same node.</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Some SQL engines like MySQL allow to disable the unique constraint check.
Ensure that this is not the case <code class="docutils literal notranslate"><span class="pre">SET</span> <span class="pre">unique_checks=1;</span></code>.</p>
</div>
<p>In order to purge old locks, this store uses a current datetime to define an
expiration date reference. This mechanism relies on all server nodes to
have synchronized clocks.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">To ensure locks don’t expire prematurely; the TTLs should be set with
enough extra time to account for any clock drift between nodes.</p>
</div>
</div>
<div class="section" id="id7">
<h3>PostgreSqlStore<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>The PdoStore relies on the <a class="reference external" href="https://www.postgresql.org/docs/current/explicit-locking.html">Advisory Locks</a> properties of the PostgreSQL
database. That means that by using <a class="reference internal" href="#lock-store-pgsql"><span class="std std-ref">PostgreSqlStore</span></a>
the locks will be automatically released at the end of the session in case the
client cannot unlock for any reason.</p>
<p>If the PostgreSQL service or the machine hosting it restarts, every lock would
be lost without notifying the running processes.</p>
<p>If the TCP connection is lost, the PostgreSQL may release locks without
notifying the application.</p>
</div>
<div class="section" id="id8">
<h3>RedisStore<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>The way Redis works is to store items in memory. That means that by using
the <a class="reference internal" href="#lock-store-redis"><span class="std std-ref">RedisStore</span></a> the locks are not persisted
and may disappear by mistake at anytime.</p>
<p>If the Redis service or the machine hosting it restarts, every locks would
be lost without notifying the running processes.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">To avoid that someone else acquires a lock after a restart, it’s recommended
to delay service start and wait at least as long as the longest lock TTL.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Redis can be configured to persist items on disk, but this option would
slow down writes on the service. This could go against other uses of the
server.</p>
</div>
<p>When the Redis service is shared and used for multiple usages, locks could be
removed by mistake.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">The command <code class="docutils literal notranslate"><span class="pre">FLUSHDB</span></code> must not be called, or locks should be stored in a
dedicated Redis service away from Cache.</p>
</div>
</div>
<div class="section" id="id9">
<h3>CombinedStore<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>Combined stores allow to store locks across several backends. It’s a common
mistake to think that the lock mechanism will be more reliable. This is wrong.
The <code class="docutils literal notranslate"><span class="pre">CombinedStore</span></code> will be, at best, as reliable as the least reliable of
all managed stores. As soon as one managed store returns erroneous information,
the <code class="docutils literal notranslate"><span class="pre">CombinedStore</span></code> won’t be reliable.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">All concurrent processes must use the same configuration, with the same
amount of managed stored and the same endpoint.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Instead of using a cluster of Redis or Memcached servers, it’s better to use
a <code class="docutils literal notranslate"><span class="pre">CombinedStore</span></code> with a single server per managed store.</p>
</div>
</div>
<div class="section" id="id10">
<h3>SemaphoreStore<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>Semaphores are handled by the Kernel level. In order to be reliable, processes
must run on the same machine, virtual machine or container. Be careful when
updating a Kubernetes or Swarm service because for a short period of time, there
can be two running containers in parallel.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">All concurrent processes must use the same machine. Before starting a
concurrent process on a new machine, check that other process are stopped
on the old one.</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">When running on systemd with non-system user and option <code class="docutils literal notranslate"><span class="pre">RemoveIPC=yes</span></code>
(default value), locks are deleted by systemd when that user logs out.
Check that process is run with a system user (UID &lt;= SYS_UID_MAX) with
<code class="docutils literal notranslate"><span class="pre">SYS_UID_MAX</span></code> defined in <code class="docutils literal notranslate"><span class="pre">/etc/login.defs</span></code>, or set the option
<code class="docutils literal notranslate"><span class="pre">RemoveIPC=off</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/systemd/logind.conf</span></code>.</p>
</div>
</div>
<div class="section" id="id11">
<h3>ZookeeperStore<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>The way ZookeeperStore works is by maintaining locks as ephemeral nodes on the
server. That means that by using <a class="reference internal" href="#lock-store-zookeeper"><span class="std std-ref">ZookeeperStore</span></a>
the locks will be automatically released at the end of the session in case the
client cannot unlock for any reason.</p>
<p>If the ZooKeeper service or the machine hosting it restarts, every lock would
be lost without notifying the running processes.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">To use ZooKeeper’s high-availability feature, you can setup a cluster of
multiple servers so that in case one of the server goes down, the majority
will still be up and serving the requests. All the available servers in the
cluster will see the same state.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As this store does not support multi-level node locks, since the clean up of
intermediate nodes becomes an overhead, all locks are maintained at the root
level.</p>
</div>
</div>
<div class="section" id="overall">
<h3>Overall<a class="headerlink" href="#overall" title="Permalink to this headline">¶</a></h3>
<p>Changing the configuration of stores should be done very carefully. For
instance, during the deployment of a new version. Processes with new
configuration must not be started while old processes with old configuration
are still running.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2004-2020 Fabien Potencier

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>