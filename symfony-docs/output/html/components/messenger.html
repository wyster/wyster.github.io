

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>The Messenger Component &mdash; Symfony Framework Documentation  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/rtd_custom.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="The Mime Component" href="mime.html" />
    <link rel="prev" title="The Lock Component" href="lock.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #f0f0f0" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/symfony-logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                5.2}
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../quick_tour/index.html">The Quick Tour</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index.html">Getting Started</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../best_practices.html">The Symfony Framework Best Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bundles.html">The Bundle System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cache.html">Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../console.html">Console Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doctrine.html">Databases and the Doctrine ORM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment.html">How to Deploy a Symfony Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../email.html">Swift Mailer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../event_dispatcher.html">Events and Event Listeners</a></li>
<li class="toctree-l1"><a class="reference internal" href="../forms.html">Forms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../frontend.html">Managing CSS and JavaScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../http_cache.html">HTTP Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../http_client.html">HTTP Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lock.html">Dealing with Concurrency with Locks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mailer.html">Sending Emails with Mailer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mercure.html">Pushing Data to Clients Using the Mercure Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../messenger.html">Messenger: Sync &amp; Queued Message Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration.html">Migrating an Existing Application to Symfony</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notifier.html">Creating and Sending Notifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../profiler.html">Profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rate_limiter.html">Rate Limiter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../routing.html">Routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../session.html">Sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup.html">Installing &amp; Setting up the Symfony Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../serializer.html">How to Use the Serializer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../service_container.html">Service Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../translation.html">Translations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../validation.html">Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../web_link.html">Asset Preloading and Resource Hints with HTTP/2 and WebLink</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflow.html">Workflow</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">The Components</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="using_components.html">How to Install and Use the Symfony Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="asset.html">The Asset Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="browser_kit.html">The BrowserKit Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="cache.html">The Cache Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="config.html">The Config Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="console.html">The Console Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="contracts.html">The Contracts Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="css_selector.html">The CssSelector Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="dependency_injection.html">The DependencyInjection Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="dom_crawler.html">The DomCrawler Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_dispatcher.html">The EventDispatcher Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="expression_language.html">The ExpressionLanguage Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="filesystem.html">The Filesystem Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="finder.html">The Finder Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="form.html">The Form Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="http_foundation.html">The HttpFoundation Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="http_kernel.html">The HttpKernel Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="inflector.html">The Inflector Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="intl.html">The Intl Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="ldap.html">The Ldap Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="lock.html">The Lock Component</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">The Messenger Component</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#concepts">Concepts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bus">Bus</a></li>
<li class="toctree-l3"><a class="reference internal" href="#handlers">Handlers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-metadata-to-messages-envelopes">Adding Metadata to Messages (Envelopes)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transports">Transports</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#your-own-sender">Your own Sender</a></li>
<li class="toctree-l4"><a class="reference internal" href="#your-own-receiver">Your own Receiver</a></li>
<li class="toctree-l4"><a class="reference internal" href="#receiver-and-sender-on-the-same-bus">Receiver and Sender on the same Bus</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#learn-more">Learn more</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../messenger.html">Messenger: Sync &amp; Queued Message Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="../messenger/custom-transport.html">How to Create Your own Messenger Transport</a></li>
<li class="toctree-l4"><a class="reference internal" href="../messenger/dispatch_after_current_bus.html">Transactional Messages: Handle New Messages After Handling is Done</a></li>
<li class="toctree-l4"><a class="reference internal" href="../messenger/handler_results.html">Getting Results from your Handler</a></li>
<li class="toctree-l4"><a class="reference internal" href="../messenger/multiple_buses.html">Multiple Buses</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mime.html">The Mime Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="options_resolver.html">The OptionsResolver Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="phpunit_bridge.html">The PHPUnit Bridge</a></li>
<li class="toctree-l2"><a class="reference internal" href="process.html">The Process Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="property_access.html">The PropertyAccess Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="property_info.html">The PropertyInfo Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="psr7.html">The PSR-7 Bridge</a></li>
<li class="toctree-l2"><a class="reference internal" href="security.html">The Security Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="semaphore.html">The Semaphore Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="serializer.html">The Serializer Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="string.html">The String Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="uid.html">The UID Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="validator.html">The Validator Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="var_dumper.html">The VarDumper Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="var_exporter.html">The VarExporter Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflow.html">The Workflow Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="yaml.html">The Yaml Component</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference Documents</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../create_framework/index.html">Create your own PHP Framework</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Symfony Framework Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">The Components</a> &raquo;</li>
        
      <li>The Messenger Component</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/components/messenger.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="the-messenger-component">
<span id="index-0"></span><h1>The Messenger Component<a class="headerlink" href="#the-messenger-component" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p>The Messenger component helps applications send and receive messages to/from
other applications or via message queues.</p>
<p>The component is greatly inspired by Matthias Noback’s series of
<a class="reference external" href="https://matthiasnoback.nl/tags/command%20bus/">blog posts about command buses</a> and the <a class="reference external" href="http://docs.simplebus.io/en/latest/">SimpleBus project</a>.</p>
</div></blockquote>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">This article explains how to use the Messenger features as an independent
component in any PHP application. Read the <a class="reference internal" href="../messenger.html"><span class="doc">Messenger: Sync &amp; Queued Message Handling</span></a> article to
learn about how to use it in Symfony applications.</p>
</div>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> composer require symfony/messenger
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you install this component outside of a Symfony application, you must
require the <code class="docutils literal notranslate"><span class="pre">vendor/autoload.php</span></code> file in your code to enable the class
autoloading mechanism provided by Composer. Read
<a class="reference internal" href="using_components.html"><span class="doc">this article</span></a> for more details.</p>
</div>
</div>
<div class="section" id="concepts">
<h2>Concepts<a class="headerlink" href="#concepts" title="Permalink to this headline">¶</a></h2>
<object data="../_images/components/messenger/overview.svg" type="image/svg+xml"></object><dl class="docutils">
<dt><strong>Sender</strong>:</dt>
<dd>Responsible for serializing and sending messages to <em>something</em>. This
something can be a message broker or a third party API for example.</dd>
<dt><strong>Receiver</strong>:</dt>
<dd>Responsible for retrieving, deserializing and forwarding messages to handler(s).
This can be a message queue puller or an API endpoint for example.</dd>
<dt><strong>Handler</strong>:</dt>
<dd>Responsible for handling messages using the business logic applicable to the messages.
Handlers are called by the <code class="docutils literal notranslate"><span class="pre">HandleMessageMiddleware</span></code> middleware.</dd>
<dt><strong>Middleware</strong>:</dt>
<dd>Middleware can access the message and its wrapper (the envelope) while it is
dispatched through the bus.
Literally <em>“the software in the middle”</em>, those are not about core concerns
(business logic) of an application. Instead, they are cross cutting concerns
applicable throughout the application and affecting the entire message bus.
For instance: logging, validating a message, starting a transaction, …
They are also responsible for calling the next middleware in the chain,
which means they can tweak the envelope, by adding stamps to it or even
replacing it, as well as interrupt the middleware chain. Middleware are called
both when a message is originally dispatched and again later when a message
is received from a transport,</dd>
<dt><strong>Envelope</strong>:</dt>
<dd>Messenger specific concept, it gives full flexibility inside the message bus,
by wrapping the messages into it, allowing to add useful information inside
through <em>envelope stamps</em>.</dd>
<dt><strong>Envelope Stamps</strong>:</dt>
<dd>Piece of information you need to attach to your message: serializer context
to use for transport, markers identifying a received message or any sort of
metadata your middleware or transport layer may use.</dd>
</dl>
</div>
<div class="section" id="bus">
<h2>Bus<a class="headerlink" href="#bus" title="Permalink to this headline">¶</a></h2>
<p>The bus is used to dispatch messages. The behavior of the bus is in its ordered
middleware stack. The component comes with a set of middleware that you can use.</p>
<p>When using the message bus with Symfony’s FrameworkBundle, the following middleware
are configured for you:</p>
<ol class="arabic simple">
<li><code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Messenger/Middleware/SendMessageMiddleware.php" title="Symfony\Component\Messenger\Middleware\SendMessageMiddleware"><span class="pre">SendMessageMiddleware</span></a></code> (enables asynchronous processing, logs the processing of your messages if you pass a logger)</li>
<li><code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Messenger/Middleware/HandleMessageMiddleware.php" title="Symfony\Component\Messenger\Middleware\HandleMessageMiddleware"><span class="pre">HandleMessageMiddleware</span></a></code> (calls the registered handler(s))</li>
</ol>
<p>Example:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">App\Message\MyMessage</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\MessageHandler\MyMessageHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Messenger\Handler\HandlersLocator</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Messenger\MessageBus</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Messenger\Middleware\HandleMessageMiddleware</span><span class="p">;</span>

<span class="nv">$handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyMessageHandler</span><span class="p">();</span>

<span class="nv">$bus</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MessageBus</span><span class="p">([</span>
    <span class="k">new</span> <span class="nx">HandleMessageMiddleware</span><span class="p">(</span><span class="k">new</span> <span class="nx">HandlersLocator</span><span class="p">([</span>
        <span class="nx">MyMessage</span><span class="o">::</span><span class="na">class</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$handler</span><span class="p">],</span>
    <span class="p">])),</span>
<span class="p">]);</span>

<span class="nv">$bus</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">MyMessage</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">));</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Every middleware needs to implement the <code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Messenger/Middleware/MiddlewareInterface.php" title="Symfony\Component\Messenger\Middleware\MiddlewareInterface"><span class="pre">MiddlewareInterface</span></a></code>.</p>
</div>
</div>
<div class="section" id="handlers">
<h2>Handlers<a class="headerlink" href="#handlers" title="Permalink to this headline">¶</a></h2>
<p>Once dispatched to the bus, messages will be handled by a “message handler”. A
message handler is a PHP callable (i.e. a function or an instance of a class)
that will do the required processing for your message:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="nx">App\MessageHandler</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Message\MyMessage</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyMessageHandler</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__invoke</span><span class="p">(</span><span class="nx">MyMessage</span> <span class="nv">$message</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Message processing...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="adding-metadata-to-messages-envelopes">
<span id="messenger-envelopes"></span><h2>Adding Metadata to Messages (Envelopes)<a class="headerlink" href="#adding-metadata-to-messages-envelopes" title="Permalink to this headline">¶</a></h2>
<p>If you need to add metadata or some configuration to a message, wrap it with the
<code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Messenger/Envelope.php" title="Symfony\Component\Messenger\Envelope"><span class="pre">Envelope</span></a></code> class and add stamps.
For example, to set the serialization groups used when the message goes
through the transport layer, use the <code class="docutils literal notranslate"><span class="pre">SerializerStamp</span></code> stamp:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Symfony\Component\Messenger\Envelope</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Messenger\Stamp\SerializerStamp</span><span class="p">;</span>

<span class="nv">$bus</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">(</span>
    <span class="p">(</span><span class="k">new</span> <span class="nx">Envelope</span><span class="p">(</span><span class="nv">$message</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">with</span><span class="p">(</span><span class="k">new</span> <span class="nx">SerializerStamp</span><span class="p">([</span>
        <span class="c1">// groups are applied to the whole message, so make sure</span>
        <span class="c1">// to define the group for every embedded object</span>
        <span class="s1">&#39;groups&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;my_serialization_groups&#39;</span><span class="p">],</span>
    <span class="p">]))</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Here are some important envelope stamps that are shipped with the Symfony Messenger:</p>
<ol class="arabic simple">
<li><code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Messenger/Stamp/DelayStamp.php" title="Symfony\Component\Messenger\Stamp\DelayStamp"><span class="pre">DelayStamp</span></a></code>,
to delay handling of an asynchronous message.</li>
<li><code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Messenger/Stamp/DispatchAfterCurrentBusStamp.php" title="Symfony\Component\Messenger\Stamp\DispatchAfterCurrentBusStamp"><span class="pre">DispatchAfterCurrentBusStamp</span></a></code>,
to make the message be handled after the current bus has executed. Read more
at <a class="reference internal" href="../messenger/dispatch_after_current_bus.html"><span class="doc">Transactional Messages: Handle New Messages After Handling is Done</span></a>.</li>
<li><code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Messenger/Stamp/HandledStamp.php" title="Symfony\Component\Messenger\Stamp\HandledStamp"><span class="pre">HandledStamp</span></a></code>,
a stamp that marks the message as handled by a specific handler.
Allows accessing the handler returned value and the handler name.</li>
<li><code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Messenger/Stamp/ReceivedStamp.php" title="Symfony\Component\Messenger\Stamp\ReceivedStamp"><span class="pre">ReceivedStamp</span></a></code>,
an internal stamp that marks the message as received from a transport.</li>
<li><code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Messenger/Stamp/SentStamp.php" title="Symfony\Component\Messenger\Stamp\SentStamp"><span class="pre">SentStamp</span></a></code>,
a stamp that marks the message as sent by a specific sender.
Allows accessing the sender FQCN and the alias if available from the
<code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Messenger/Transport/Sender/SendersLocator.php" title="Symfony\Component\Messenger\Transport\Sender\SendersLocator"><span class="pre">SendersLocator</span></a></code>.</li>
<li><code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Messenger/Stamp/SerializerStamp.php" title="Symfony\Component\Messenger\Stamp\SerializerStamp"><span class="pre">SerializerStamp</span></a></code>,
to configure the serialization groups used by the transport.</li>
<li><code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Messenger/Stamp/ValidationStamp.php" title="Symfony\Component\Messenger\Stamp\ValidationStamp"><span class="pre">ValidationStamp</span></a></code>,
to configure the validation groups used when the validation middleware is enabled.</li>
</ol>
<p>Instead of dealing directly with the messages in the middleware you receive the envelope.
Hence you can inspect the envelope content and its stamps, or add any:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">App\Message\Stamp\AnotherStamp</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Messenger\Envelope</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Messenger\Middleware\MiddlewareInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Messenger\Middleware\StackInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Messenger\Stamp\ReceivedStamp</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyOwnMiddleware</span> <span class="k">implements</span> <span class="nx">MiddlewareInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">Envelope</span> <span class="nv">$envelope</span><span class="p">,</span> <span class="nx">StackInterface</span> <span class="nv">$stack</span><span class="p">)</span><span class="o">:</span> <span class="nx">Envelope</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">null</span> <span class="o">!==</span> <span class="nv">$envelope</span><span class="o">-&gt;</span><span class="na">last</span><span class="p">(</span><span class="nx">ReceivedStamp</span><span class="o">::</span><span class="na">class</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// Message just has been received...</span>

            <span class="c1">// You could for example add another stamp.</span>
            <span class="nv">$envelope</span> <span class="o">=</span> <span class="nv">$envelope</span><span class="o">-&gt;</span><span class="na">with</span><span class="p">(</span><span class="k">new</span> <span class="nx">AnotherStamp</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Message was just originally dispatched</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">next</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$envelope</span><span class="p">,</span> <span class="nv">$stack</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The above example will forward the message to the next middleware with an
additional stamp <em>if</em> the message has just been received (i.e. has at least one
<code class="docutils literal notranslate"><span class="pre">ReceivedStamp</span></code> stamp). You can create your own stamps by implementing
<code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Messenger/Stamp/StampInterface.php" title="Symfony\Component\Messenger\Stamp\StampInterface"><span class="pre">StampInterface</span></a></code>.</p>
<p>If you want to examine all stamps on an envelope, use the <code class="docutils literal notranslate"><span class="pre">$envelope-&gt;all()</span></code>
method, which returns all stamps grouped by type (FQCN). Alternatively, you can
iterate through all stamps of a specific type by using the FQCN as first
parameter of this method (e.g. <code class="docutils literal notranslate"><span class="pre">$envelope-&gt;all(ReceivedStamp::class)</span></code>).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Any stamp must be serializable using the Symfony Serializer component
if going through transport using the <code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Messenger/Transport/Serialization/Serializer.php" title="Symfony\Component\Messenger\Transport\Serialization\Serializer"><span class="pre">Serializer</span></a></code>
base serializer.</p>
</div>
</div>
<div class="section" id="transports">
<h2>Transports<a class="headerlink" href="#transports" title="Permalink to this headline">¶</a></h2>
<p>In order to send and receive messages, you will have to configure a transport. A
transport will be responsible for communicating with your message broker or 3rd parties.</p>
<div class="section" id="your-own-sender">
<h3>Your own Sender<a class="headerlink" href="#your-own-sender" title="Permalink to this headline">¶</a></h3>
<p>Imagine that you already have an <code class="docutils literal notranslate"><span class="pre">ImportantAction</span></code> message going through the
message bus and being handled by a handler. Now, you also want to send this
message as an email (using the <a class="reference internal" href="mime.html"><span class="doc">Mime</span></a> and
<a class="reference internal" href="../mailer.html"><span class="doc">Mailer</span></a> components).</p>
<p>Using the <code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Messenger/Transport/Sender/SenderInterface.php" title="Symfony\Component\Messenger\Transport\Sender\SenderInterface"><span class="pre">SenderInterface</span></a></code>,
you can create your own message sender:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="nx">App\MessageSender</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Message\ImportantAction</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Mailer\MailerInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Messenger\Envelope</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Messenger\Transport\Sender\SenderInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Mime\Email</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ImportantActionToEmailSender</span> <span class="k">implements</span> <span class="nx">SenderInterface</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$mailer</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$toEmail</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">MailerInterface</span> <span class="nv">$mailer</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$toEmail</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mailer</span> <span class="o">=</span> <span class="nv">$mailer</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">toEmail</span> <span class="o">=</span> <span class="nv">$toEmail</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">send</span><span class="p">(</span><span class="nx">Envelope</span> <span class="nv">$envelope</span><span class="p">)</span><span class="o">:</span> <span class="nx">Envelope</span>
    <span class="p">{</span>
        <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$envelope</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$message</span> <span class="nx">instanceof</span> <span class="nx">ImportantAction</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\InvalidArgumentException</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;This transport only supports &quot;%s&quot; messages.&#39;</span><span class="p">,</span> <span class="nx">ImportantAction</span><span class="o">::</span><span class="na">class</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mailer</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span>
            <span class="p">(</span><span class="k">new</span> <span class="nx">Email</span><span class="p">())</span>
                <span class="o">-&gt;</span><span class="na">to</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">toEmail</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">subject</span><span class="p">(</span><span class="s1">&#39;Important action made&#39;</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">html</span><span class="p">(</span><span class="s1">&#39;&lt;h1&gt;Important action&lt;/h1&gt;&lt;p&gt;Made by &#39;</span><span class="o">.</span><span class="nv">$message</span><span class="o">-&gt;</span><span class="na">getUsername</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;&lt;/p&gt;&#39;</span><span class="p">)</span>
        <span class="p">);</span>

        <span class="k">return</span> <span class="nv">$envelope</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="your-own-receiver">
<h3>Your own Receiver<a class="headerlink" href="#your-own-receiver" title="Permalink to this headline">¶</a></h3>
<p>A receiver is responsible for getting messages from a source and dispatching
them to the application.</p>
<p>Imagine you already processed some “orders” in your application using a
<code class="docutils literal notranslate"><span class="pre">NewOrder</span></code> message. Now you want to integrate with a 3rd party or a legacy
application but you can’t use an API and need to use a shared CSV file with new
orders.</p>
<p>You will read this CSV file and dispatch a <code class="docutils literal notranslate"><span class="pre">NewOrder</span></code> message. All you need to
do is to write your own CSV receiver:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="nx">App\MessageReceiver</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Message\NewOrder</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Messenger\Envelope</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Messenger\Exception\MessageDecodingFailedException</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Messenger\Transport\Receiver\ReceiverInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Serializer\SerializerInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">NewOrdersFromCsvFileReceiver</span> <span class="k">implements</span> <span class="nx">ReceiverInterface</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$serializer</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$filePath</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">SerializerInterface</span> <span class="nv">$serializer</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$filePath</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">serializer</span> <span class="o">=</span> <span class="nv">$serializer</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">filePath</span> <span class="o">=</span> <span class="nv">$filePath</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">get</span><span class="p">()</span><span class="o">:</span> <span class="nx">iterable</span>
    <span class="p">{</span>
        <span class="c1">// Receive the envelope according to your transport ($yourEnvelope here),</span>
        <span class="c1">// in most cases, using a connection is the easiest solution.</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">null</span> <span class="o">===</span> <span class="nv">$yourEnvelope</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">[];</span>
        <span class="p">}</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$envelope</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">serializer</span><span class="o">-&gt;</span><span class="na">decode</span><span class="p">([</span>
                <span class="s1">&#39;body&#39;</span> <span class="o">=&gt;</span> <span class="nv">$yourEnvelope</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">],</span>
                <span class="s1">&#39;headers&#39;</span> <span class="o">=&gt;</span> <span class="nv">$yourEnvelope</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">],</span>
            <span class="p">]);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">MessageDecodingFailedException</span> <span class="nv">$exception</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connection</span><span class="o">-&gt;</span><span class="na">reject</span><span class="p">(</span><span class="nv">$yourEnvelope</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]);</span>
            <span class="k">throw</span> <span class="nv">$exception</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">[</span><span class="nv">$envelope</span><span class="o">-&gt;</span><span class="na">with</span><span class="p">(</span><span class="k">new</span> <span class="nx">CustomStamp</span><span class="p">(</span><span class="nv">$yourEnvelope</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))];</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">ack</span><span class="p">(</span><span class="nx">Envelope</span> <span class="nv">$envelope</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="c1">// Add information about the handled message</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">reject</span><span class="p">(</span><span class="nx">Envelope</span> <span class="nv">$envelope</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="c1">// In the case of a custom connection</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connection</span><span class="o">-&gt;</span><span class="na">reject</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">findCustomStamp</span><span class="p">(</span><span class="nv">$envelope</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="receiver-and-sender-on-the-same-bus">
<h3>Receiver and Sender on the same Bus<a class="headerlink" href="#receiver-and-sender-on-the-same-bus" title="Permalink to this headline">¶</a></h3>
<p>To allow sending and receiving messages on the same bus and prevent an infinite
loop, the message bus will add a <code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Messenger/Stamp/ReceivedStamp.php" title="Symfony\Component\Messenger\Stamp\ReceivedStamp"><span class="pre">ReceivedStamp</span></a></code>
stamp to the message envelopes and the <code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/Messenger/Middleware/SendMessageMiddleware.php" title="Symfony\Component\Messenger\Middleware\SendMessageMiddleware"><span class="pre">SendMessageMiddleware</span></a></code>
middleware will know it should not route these messages again to a transport.</p>
</div>
</div>
<div class="section" id="learn-more">
<h2>Learn more<a class="headerlink" href="#learn-more" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../messenger.html">Messenger: Sync &amp; Queued Message Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../messenger/custom-transport.html">How to Create Your own Messenger Transport</a></li>
<li class="toctree-l1"><a class="reference internal" href="../messenger/dispatch_after_current_bus.html">Transactional Messages: Handle New Messages After Handling is Done</a></li>
<li class="toctree-l1"><a class="reference internal" href="../messenger/handler_results.html">Getting Results from your Handler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../messenger/multiple_buses.html">Multiple Buses</a></li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2004-2020 Fabien Potencier

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>