

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>How to Test Code that Interacts with the Database &mdash; Symfony Framework Documentation  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/rtd_custom.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to Deploy a Symfony Application" href="../deployment.html" />
    <link rel="prev" title="Store Sessions in a Database" href="../session/database.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #f0f0f0" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/symfony-logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                5.2}
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../quick_tour/index.html">The Quick Tour</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index.html">Getting Started</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../best_practices.html">The Symfony Framework Best Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bundles.html">The Bundle System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cache.html">Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../console.html">Console Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doctrine.html">Databases and the Doctrine ORM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment.html">How to Deploy a Symfony Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../email.html">Swift Mailer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../event_dispatcher.html">Events and Event Listeners</a></li>
<li class="toctree-l1"><a class="reference internal" href="../forms.html">Forms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../frontend.html">Managing CSS and JavaScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../http_cache.html">HTTP Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../http_client.html">HTTP Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lock.html">Dealing with Concurrency with Locks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mailer.html">Sending Emails with Mailer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mercure.html">Pushing Data to Clients Using the Mercure Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../messenger.html">Messenger: Sync &amp; Queued Message Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration.html">Migrating an Existing Application to Symfony</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notifier.html">Creating and Sending Notifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../profiler.html">Profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rate_limiter.html">Rate Limiter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../routing.html">Routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../session.html">Sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup.html">Installing &amp; Setting up the Symfony Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../serializer.html">How to Use the Serializer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../service_container.html">Service Container</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../testing.html">Testing</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../testing.html#the-phpunit-testing-framework">The PHPUnit Testing Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#unit-tests">Unit Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#functional-tests">Functional Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#testing-against-different-sets-of-data">Testing against Different Sets of Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#working-with-the-test-client">Working with the Test Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#the-crawler">The Crawler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html#testing-configuration">Testing Configuration</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../testing.html#learn-more">Learn more</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="bootstrap.html">How to Customize the Bootstrap Process before Running Tests</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">How to Test Code that Interacts with the Database</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#configuring-a-database-for-tests">Configuring a Database for Tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#resetting-the-database-automatically-before-each-test">Resetting the Database Automatically Before each Test</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dummy-data-fixtures">Dummy Data Fixtures</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mocking-a-doctrine-repository-in-unit-tests">Mocking a Doctrine Repository in Unit Tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#functional-testing-of-a-doctrine-repository">Functional Testing of A Doctrine Repository</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="functional_tests_assertions.html">Functional Test specific Assertions</a></li>
<li class="toctree-l3"><a class="reference internal" href="http_authentication.html">How to Simulate HTTP Authentication in a Functional Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="insulating_clients.html">How to Test the Interaction of several Clients</a></li>
<li class="toctree-l3"><a class="reference internal" href="profiling.html">How to Use the Profiler in a Functional Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../components/dom_crawler.html">The DomCrawler Component</a></li>
<li class="toctree-l3"><a class="reference internal" href="../components/css_selector.html">The CssSelector Component</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../translation.html">Translations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../validation.html">Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../web_link.html">Asset Preloading and Resource Hints with HTTP/2 and WebLink</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflow.html">Workflow</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../components/index.html">The Components</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference Documents</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../create_framework/index.html">Create your own PHP Framework</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Symfony Framework Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../doctrine.html">Databases and the Doctrine ORM</a> &raquo;</li>
        
      <li>How to Test Code that Interacts with the Database</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/testing/database.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="how-to-test-code-that-interacts-with-the-database">
<span id="index-0"></span><h1>How to Test Code that Interacts with the Database<a class="headerlink" href="#how-to-test-code-that-interacts-with-the-database" title="Permalink to this headline">¶</a></h1>
<div class="section" id="configuring-a-database-for-tests">
<h2>Configuring a Database for Tests<a class="headerlink" href="#configuring-a-database-for-tests" title="Permalink to this headline">¶</a></h2>
<p>Tests that interact with the database should use their own separate database to
not mess with the databases used in the other <a class="reference internal" href="../configuration.html#configuration-environments"><span class="std std-ref">configuration environments</span></a>.
To do that, edit or create the <code class="docutils literal notranslate"><span class="pre">.env.test.local</span></code> file at the root directory of
your project and define the new value for the <code class="docutils literal notranslate"><span class="pre">DATABASE_URL</span></code> env var:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># .env.test.local</span>
<span class="nv">DATABASE_URL</span><span class="o">=</span><span class="s2">&quot;mysql://USERNAME:PASSWORD@127.0.0.1:3306/DB_NAME?serverVersion=5.7&quot;</span>
</pre></div>
</td></tr></table></div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">A common practice is to append the <code class="docutils literal notranslate"><span class="pre">_test</span></code> suffix to the original database
names in tests. If the database name in production is called <code class="docutils literal notranslate"><span class="pre">project_acme</span></code>
the name of the testing database could be <code class="docutils literal notranslate"><span class="pre">project_acme_test</span></code>.</p>
</div>
<p>The above assumes that each developer/machine uses a different database for the
tests. If the entire team uses the same settings for tests, edit or create the
<code class="docutils literal notranslate"><span class="pre">.env.test</span></code> file instead and commit it to the shared repository. Learn more
about <a class="reference internal" href="../configuration.html#configuration-multiple-env-files"><span class="std std-ref">using multiple .env files in Symfony applications</span></a>.</p>
</div>
<div class="section" id="resetting-the-database-automatically-before-each-test">
<h2>Resetting the Database Automatically Before each Test<a class="headerlink" href="#resetting-the-database-automatically-before-each-test" title="Permalink to this headline">¶</a></h2>
<p>Tests should be independent from each other to avoid side effects. For example,
if some test modifies the database (by adding or removing an entity) it could
change the results of other tests. Run the following command to install a bundle
that ensures that each test is run with the same unmodified database:</p>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> composer require --dev dama/doctrine-test-bundle
</pre></div>
</td></tr></table></div>
<p>Now, enable it as a PHPUnit extension or listener:</p>
<div class="highlight-xml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- phpunit.xml.dist --&gt;</span>
<span class="nt">&lt;phpunit&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>

    <span class="c">&lt;!-- Add this for PHPUnit 7.5 or higher --&gt;</span>
    <span class="nt">&lt;extensions&gt;</span>
        <span class="nt">&lt;extension</span> <span class="na">class=</span><span class="s">&quot;DAMA\DoctrineTestBundle\PHPUnit\PHPUnitExtension&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/extensions&gt;</span>

    <span class="c">&lt;!-- Add this for PHPUnit 7.0 until 7.4 --&gt;</span>
    <span class="nt">&lt;listeners&gt;</span>
        <span class="nt">&lt;listener</span> <span class="na">class=</span><span class="s">&quot;\DAMA\DoctrineTestBundle\PHPUnit\PHPUnitListener&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/listeners&gt;</span>
<span class="nt">&lt;/phpunit&gt;</span>
</pre></div>
</td></tr></table></div>
<p>This bundle uses a clever trick to avoid side effects without sacrificing
performance: it begins a database transaction before every test and rolls it
back automatically after the test finishes to undo all changes. Read more in the
documentation of the <a class="reference external" href="https://github.com/dmaicher/doctrine-test-bundle">DAMADoctrineTestBundle</a>.</p>
</div>
<div class="section" id="dummy-data-fixtures">
<span id="doctrine-fixtures"></span><h2>Dummy Data Fixtures<a class="headerlink" href="#dummy-data-fixtures" title="Permalink to this headline">¶</a></h2>
<p>Instead of using the real data from the production database, it’s common to use
fake or dummy data in the test database. This is usually called <em>“fixtures data”</em>
and Doctrine provides a library to create and load them. Install it with:</p>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> composer require --dev doctrine/doctrine-fixtures-bundle
</pre></div>
</td></tr></table></div>
<p>Then, use the <code class="docutils literal notranslate"><span class="pre">make:fixtures</span></code> command to generate an empty fixture class:</p>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console make:fixtures

<span class="go">The class name of the fixtures to create (e.g. AppFixtures):</span>
<span class="gp">&gt;</span> ProductFixture
</pre></div>
</td></tr></table></div>
<p>Customize the new class to load <code class="docutils literal notranslate"><span class="pre">Product</span></code> objects into Doctrine:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/DataFixtures/ProductFixture.php</span>
<span class="k">namespace</span> <span class="nx">App\DataFixtures</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\Product</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\Bundle\FixturesBundle\Fixture</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\Persistence\ObjectManager</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ProductFixture</span> <span class="k">extends</span> <span class="nx">Fixture</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">load</span><span class="p">(</span><span class="nx">ObjectManager</span> <span class="nv">$manager</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$product</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Product</span><span class="p">();</span>
        <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="s1">&#39;Priceless widget&#39;</span><span class="p">);</span>
        <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setPrice</span><span class="p">(</span><span class="mf">14.50</span><span class="p">);</span>
        <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setDescription</span><span class="p">(</span><span class="s1">&#39;Ok, I guess it *does* have a price&#39;</span><span class="p">);</span>
        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$product</span><span class="p">);</span>

        <span class="c1">// add more products</span>

        <span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Empty the database and reload <em>all</em> the fixture classes with:</p>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console doctrine:fixtures:load
</pre></div>
</td></tr></table></div>
<p>For more information, read the <a class="reference external" href="https://symfony.com/doc/current/bundles/DoctrineFixturesBundle/index.html">DoctrineFixturesBundle documentation</a>.</p>
</div>
<div class="section" id="mocking-a-doctrine-repository-in-unit-tests">
<h2>Mocking a Doctrine Repository in Unit Tests<a class="headerlink" href="#mocking-a-doctrine-repository-in-unit-tests" title="Permalink to this headline">¶</a></h2>
<p><strong>Unit testing Doctrine repositories is not recommended</strong>. Repositories are
meant to be tested against a real database connection. However, in case you
still need to do this, look at the following example.</p>
<p>Suppose the class you want to test looks like this:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/Salary/SalaryCalculator.php</span>
<span class="k">namespace</span> <span class="nx">App\Salary</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\Employee</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\Persistence\ObjectManager</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">SalaryCalculator</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$objectManager</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">ObjectManager</span> <span class="nv">$objectManager</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">objectManager</span> <span class="o">=</span> <span class="nv">$objectManager</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">calculateTotalSalary</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$employeeRepository</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">objectManager</span>
            <span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">Employee</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$employee</span> <span class="o">=</span> <span class="nv">$employeeRepository</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$employee</span><span class="o">-&gt;</span><span class="na">getSalary</span><span class="p">()</span> <span class="o">+</span> <span class="nv">$employee</span><span class="o">-&gt;</span><span class="na">getBonus</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Since the <code class="docutils literal notranslate"><span class="pre">EntityManagerInterface</span></code> gets injected into the class through the
constructor, you can pass a mock object within a test:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// tests/Salary/SalaryCalculatorTest.php</span>
<span class="k">namespace</span> <span class="nx">App\Tests\Salary</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\Employee</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Salary\SalaryCalculator</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\Persistence\ObjectManager</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\Persistence\ObjectRepository</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PHPUnit\Framework\TestCase</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">SalaryCalculatorTest</span> <span class="k">extends</span> <span class="nx">TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testCalculateTotalSalary</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$employee</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Employee</span><span class="p">();</span>
        <span class="nv">$employee</span><span class="o">-&gt;</span><span class="na">setSalary</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
        <span class="nv">$employee</span><span class="o">-&gt;</span><span class="na">setBonus</span><span class="p">(</span><span class="mi">1100</span><span class="p">);</span>

        <span class="c1">// Now, mock the repository so it returns the mock of the employee</span>
        <span class="nv">$employeeRepository</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createMock</span><span class="p">(</span><span class="nx">ObjectRepository</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="c1">// use getMock() on PHPUnit 5.3 or below</span>
        <span class="c1">// $employeeRepository = $this-&gt;getMock(ObjectRepository::class);</span>
        <span class="nv">$employeeRepository</span><span class="o">-&gt;</span><span class="na">expects</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">any</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="na">method</span><span class="p">(</span><span class="s1">&#39;find&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">willReturn</span><span class="p">(</span><span class="nv">$employee</span><span class="p">);</span>

        <span class="c1">// Last, mock the EntityManager to return the mock of the repository</span>
        <span class="c1">// (this is not needed if the class being tested injects the</span>
        <span class="c1">// repository it uses instead of the entire object manager)</span>
        <span class="nv">$objectManager</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createMock</span><span class="p">(</span><span class="nx">ObjectManager</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="c1">// use getMock() on PHPUnit 5.3 or below</span>
        <span class="c1">// $objectManager = $this-&gt;getMock(ObjectManager::class);</span>
        <span class="nv">$objectManager</span><span class="o">-&gt;</span><span class="na">expects</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">any</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="na">method</span><span class="p">(</span><span class="s1">&#39;getRepository&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">willReturn</span><span class="p">(</span><span class="nv">$employeeRepository</span><span class="p">);</span>

        <span class="nv">$salaryCalculator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SalaryCalculator</span><span class="p">(</span><span class="nv">$objectManager</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">2100</span><span class="p">,</span> <span class="nv">$salaryCalculator</span><span class="o">-&gt;</span><span class="na">calculateTotalSalary</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In this example, you are building the mocks from the inside out, first creating
the employee which gets returned by the <code class="docutils literal notranslate"><span class="pre">Repository</span></code>, which itself gets
returned by the <code class="docutils literal notranslate"><span class="pre">EntityManager</span></code>. This way, no real class is involved in
testing.</p>
</div>
<div class="section" id="functional-testing-of-a-doctrine-repository">
<h2>Functional Testing of A Doctrine Repository<a class="headerlink" href="#functional-testing-of-a-doctrine-repository" title="Permalink to this headline">¶</a></h2>
<p>In <a class="reference internal" href="../testing.html#functional-tests"><span class="std std-ref">functional tests</span></a> you’ll make queries to the
database using the actual Doctrine repositories, instead of mocking them. To do
so, get the entity manager via the service container as follows:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// tests/Repository/ProductRepositoryTest.php</span>
<span class="k">namespace</span> <span class="nx">App\Tests\Repository</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\Product</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Test\KernelTestCase</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ProductRepositoryTest</span> <span class="k">extends</span> <span class="nx">KernelTestCase</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var \Doctrine\ORM\EntityManager</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$entityManager</span><span class="p">;</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">setUp</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="nv">$kernel</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">bootKernel</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span> <span class="o">=</span> <span class="nv">$kernel</span><span class="o">-&gt;</span><span class="na">getContainer</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;doctrine&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testSearchByName</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$product</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span>
            <span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">findOneBy</span><span class="p">([</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Priceless widget&#39;</span><span class="p">])</span>
        <span class="p">;</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertSame</span><span class="p">(</span><span class="mf">14.50</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getPrice</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">tearDown</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">tearDown</span><span class="p">();</span>

        <span class="c1">// doing this is recommended to avoid memory leaks</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span><span class="o">-&gt;</span><span class="na">close</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2004-2020 Fabien Potencier

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>