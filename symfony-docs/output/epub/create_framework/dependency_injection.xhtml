<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>The DependencyInjection Component</title>
    <link rel="stylesheet" href="../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/rtd_custom.css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-dependencyinjection-component">
<h1>The DependencyInjection Component</h1>
<p>In the previous chapter, we emptied the <code class="docutils literal notranslate"><span class="pre">Simplex\Framework</span></code> class by
extending the <code class="docutils literal notranslate"><span class="pre">HttpKernel</span></code> class from the eponymous component. Seeing this
empty class, you might be tempted to move some code from the front controller
to it:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// example.com/src/Simplex/Framework.php</span>
<span class="k">namespace</span> <span class="nx">Simplex</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Component\EventDispatcher\EventDispatcher</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\RequestStack</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpKernel</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Routing</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Framework</span> <span class="k">extends</span> <span class="nx">HttpKernel\HttpKernel</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$routes</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$context</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Routing\RequestContext</span><span class="p">();</span>
        <span class="nv">$matcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Routing\Matcher\UrlMatcher</span><span class="p">(</span><span class="nv">$routes</span><span class="p">,</span> <span class="nv">$context</span><span class="p">);</span>
        <span class="nv">$requestStack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RequestStack</span><span class="p">();</span>

        <span class="nv">$controllerResolver</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HttpKernel\Controller\ControllerResolver</span><span class="p">();</span>
        <span class="nv">$argumentResolver</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HttpKernel\Controller\ArgumentResolver</span><span class="p">();</span>

        <span class="nv">$dispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventDispatcher</span><span class="p">();</span>
        <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">addSubscriber</span><span class="p">(</span><span class="k">new</span> <span class="nx">HttpKernel\EventListener\ErrorListener</span><span class="p">(</span>
            <span class="s1">&#39;Calendar\Controller\ErrorController::exception&#39;</span>
        <span class="p">));</span>
        <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">addSubscriber</span><span class="p">(</span><span class="k">new</span> <span class="nx">HttpKernel\EventListener\RouterListener</span><span class="p">(</span><span class="nv">$matcher</span><span class="p">,</span> <span class="nv">$requestStack</span><span class="p">));</span>
        <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">addSubscriber</span><span class="p">(</span><span class="k">new</span> <span class="nx">HttpKernel\EventListener\ResponseListener</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">));</span>
        <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">addSubscriber</span><span class="p">(</span><span class="k">new</span> <span class="nx">StringResponseListener</span><span class="p">());</span>

        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$dispatcher</span><span class="p">,</span> <span class="nv">$controllerResolver</span><span class="p">,</span> <span class="nv">$requestStack</span><span class="p">,</span> <span class="nv">$argumentResolver</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The front controller code would become more concise:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// example.com/web/front.php</span>
<span class="k">require_once</span> <span class="no">__DIR__</span><span class="o">.</span><span class="s1">&#39;/../vendor/autoload.php&#39;</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Request</span><span class="p">;</span>

<span class="nv">$request</span> <span class="o">=</span> <span class="nx">Request</span><span class="o">::</span><span class="na">createFromGlobals</span><span class="p">();</span>
<span class="nv">$routes</span> <span class="o">=</span> <span class="k">include</span> <span class="no">__DIR__</span><span class="o">.</span><span class="s1">&#39;/../src/app.php&#39;</span><span class="p">;</span>

<span class="nv">$framework</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Simplex\Framework</span><span class="p">(</span><span class="nv">$routes</span><span class="p">);</span>

<span class="nv">$framework</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$request</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">();</span>
</pre></div>
</div>
<p>Having a concise front controller allows you to have several front controllers
for a single application. Why would it be useful? To allow having different
configuration for the development environment and the production one for
instance. In the development environment, you might want to have error
reporting turned on and errors displayed in the browser to ease debugging:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nb">ini_set</span><span class="p">(</span><span class="s1">&#39;display_errors&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>… but you certainly won’t want that same configuration on the production
environment. Having two different front controllers gives you the opportunity
to have a slightly different configuration for each of them.</p>
<p>So, moving code from the front controller to the framework class makes our
framework more configurable, but at the same time, it introduces a lot of
issues:</p>
<ul class="simple">
<li><p>We are not able to register custom listeners anymore as the dispatcher is
not available outside the Framework class (a workaround could be the
adding of a <code class="docutils literal notranslate"><span class="pre">Framework::getEventDispatcher()</span></code> method);</p></li>
<li><p>We have lost the flexibility we had before; you cannot change the
implementation of the <code class="docutils literal notranslate"><span class="pre">UrlMatcher</span></code> or of the <code class="docutils literal notranslate"><span class="pre">ControllerResolver</span></code>
anymore;</p></li>
<li><p>Related to the previous point, we cannot test our framework without much
effort anymore as it’s impossible to mock internal objects;</p></li>
<li><p>We cannot change the charset passed to <code class="docutils literal notranslate"><span class="pre">ResponseListener</span></code> anymore (a
workaround could be to pass it as a constructor argument).</p></li>
</ul>
<p>The previous code did not exhibit the same issues because we used dependency
injection; all dependencies of our objects were injected into their
constructors (for instance, the event dispatchers were injected into the
framework so that we had total control of its creation and configuration).</p>
<p>Does it mean that we have to make a choice between flexibility, customization,
ease of testing and not to copy and paste the same code into each application
front controller? As you might expect, there is a solution. We can solve all
these issues and some more by using the Symfony dependency injection
container:</p>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> composer require symfony/dependency-injection
</pre></div>
</td></tr></table></div>
<p>Create a new file to host the dependency injection container configuration:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// example.com/src/container.php</span>
<span class="k">use</span> <span class="nx">Simplex\Framework</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\DependencyInjection</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\DependencyInjection\Reference</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\EventDispatcher</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpKernel</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Routing</span><span class="p">;</span>

<span class="nv">$containerBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DependencyInjection\ContainerBuilder</span><span class="p">();</span>
<span class="nv">$containerBuilder</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="nx">Routing\RequestContext</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="nv">$containerBuilder</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;matcher&#39;</span><span class="p">,</span> <span class="nx">Routing\Matcher\UrlMatcher</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">setArguments</span><span class="p">([</span><span class="nv">$routes</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Reference</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">)])</span>
<span class="p">;</span>
<span class="nv">$containerBuilder</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;request_stack&#39;</span><span class="p">,</span> <span class="nx">HttpFoundation\RequestStack</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="nv">$containerBuilder</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;controller_resolver&#39;</span><span class="p">,</span> <span class="nx">HttpKernel\Controller\ControllerResolver</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="nv">$containerBuilder</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;argument_resolver&#39;</span><span class="p">,</span> <span class="nx">HttpKernel\Controller\ArgumentResolver</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

<span class="nv">$containerBuilder</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;listener.router&#39;</span><span class="p">,</span> <span class="nx">HttpKernel\EventListener\RouterListener</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">setArguments</span><span class="p">([</span><span class="k">new</span> <span class="nx">Reference</span><span class="p">(</span><span class="s1">&#39;matcher&#39;</span><span class="p">),</span> <span class="k">new</span> <span class="nx">Reference</span><span class="p">(</span><span class="s1">&#39;request_stack&#39;</span><span class="p">)])</span>
<span class="p">;</span>
<span class="nv">$containerBuilder</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;listener.response&#39;</span><span class="p">,</span> <span class="nx">HttpKernel\EventListener\ResponseListener</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">setArguments</span><span class="p">([</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">])</span>
<span class="p">;</span>
<span class="nv">$containerBuilder</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;listener.exception&#39;</span><span class="p">,</span> <span class="nx">HttpKernel\EventListener\ErrorListener</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">setArguments</span><span class="p">([</span><span class="s1">&#39;Calendar\Controller\ErrorController::exception&#39;</span><span class="p">])</span>
<span class="p">;</span>
<span class="nv">$containerBuilder</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;dispatcher&#39;</span><span class="p">,</span> <span class="nx">EventDispatcher\EventDispatcher</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">addMethodCall</span><span class="p">(</span><span class="s1">&#39;addSubscriber&#39;</span><span class="p">,</span> <span class="p">[</span><span class="k">new</span> <span class="nx">Reference</span><span class="p">(</span><span class="s1">&#39;listener.router&#39;</span><span class="p">)])</span>
    <span class="o">-&gt;</span><span class="na">addMethodCall</span><span class="p">(</span><span class="s1">&#39;addSubscriber&#39;</span><span class="p">,</span> <span class="p">[</span><span class="k">new</span> <span class="nx">Reference</span><span class="p">(</span><span class="s1">&#39;listener.response&#39;</span><span class="p">)])</span>
    <span class="o">-&gt;</span><span class="na">addMethodCall</span><span class="p">(</span><span class="s1">&#39;addSubscriber&#39;</span><span class="p">,</span> <span class="p">[</span><span class="k">new</span> <span class="nx">Reference</span><span class="p">(</span><span class="s1">&#39;listener.exception&#39;</span><span class="p">)])</span>
<span class="p">;</span>
<span class="nv">$containerBuilder</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;framework&#39;</span><span class="p">,</span> <span class="nx">Framework</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">setArguments</span><span class="p">([</span>
        <span class="k">new</span> <span class="nx">Reference</span><span class="p">(</span><span class="s1">&#39;dispatcher&#39;</span><span class="p">),</span>
        <span class="k">new</span> <span class="nx">Reference</span><span class="p">(</span><span class="s1">&#39;controller_resolver&#39;</span><span class="p">),</span>
        <span class="k">new</span> <span class="nx">Reference</span><span class="p">(</span><span class="s1">&#39;request_stack&#39;</span><span class="p">),</span>
        <span class="k">new</span> <span class="nx">Reference</span><span class="p">(</span><span class="s1">&#39;argument_resolver&#39;</span><span class="p">),</span>
    <span class="p">])</span>
<span class="p">;</span>

<span class="k">return</span> <span class="nv">$containerBuilder</span><span class="p">;</span>
</pre></div>
</div>
<p>The goal of this file is to configure your objects and their dependencies.
Nothing is instantiated during this configuration step. This is purely a
static description of the objects you need to manipulate and how to create
them. Objects will be created on-demand when you access them from the
container or when the container needs them to create other objects.</p>
<p>For instance, to create the router listener, we tell Symfony that its class
name is <code class="docutils literal notranslate"><span class="pre">Symfony\Component\HttpKernel\EventListener\RouterListener</span></code> and
that its constructor takes a matcher object (<code class="docutils literal notranslate"><span class="pre">new</span> <span class="pre">Reference('matcher')</span></code>). As
you can see, each object is referenced by a name, a string that uniquely
identifies each object. The name allows us to get an object and to reference
it in other object definitions.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By default, every time you get an object from the container, it returns
the exact same instance. That’s because a container manages your “global”
objects.</p>
</div>
<p>The front controller is now only about wiring everything together:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// example.com/web/front.php</span>
<span class="k">require_once</span> <span class="no">__DIR__</span><span class="o">.</span><span class="s1">&#39;/../vendor/autoload.php&#39;</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Request</span><span class="p">;</span>

<span class="nv">$routes</span> <span class="o">=</span> <span class="k">include</span> <span class="no">__DIR__</span><span class="o">.</span><span class="s1">&#39;/../src/app.php&#39;</span><span class="p">;</span>
<span class="nv">$container</span> <span class="o">=</span> <span class="k">include</span> <span class="no">__DIR__</span><span class="o">.</span><span class="s1">&#39;/../src/container.php&#39;</span><span class="p">;</span>

<span class="nv">$request</span> <span class="o">=</span> <span class="nx">Request</span><span class="o">::</span><span class="na">createFromGlobals</span><span class="p">();</span>

<span class="nv">$response</span> <span class="o">=</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;framework&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

<span class="nv">$response</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">();</span>
</pre></div>
</div>
<p>As all the objects are now created in the dependency injection container, the
framework code should be the previous simple version:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// example.com/src/Simplex/Framework.php</span>
<span class="k">namespace</span> <span class="nx">Simplex</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Component\HttpKernel\HttpKernel</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Framework</span> <span class="k">extends</span> <span class="nx">HttpKernel</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want a light alternative for your container, consider <a class="reference external" href="https://github.com/silexphp/Pimple">Pimple</a><span class="link-target"> [https://github.com/silexphp/Pimple]</span>, a
simple dependency injection container in about 60 lines of PHP code.</p>
</div>
<p>Now, here is how you can register a custom listener in the front controller:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// ...</span>
<span class="k">use</span> <span class="nx">Simplex\StringResponseListener</span><span class="p">;</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;listener.string_response&#39;</span><span class="p">,</span> <span class="nx">StringResponseListener</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">getDefinition</span><span class="p">(</span><span class="s1">&#39;dispatcher&#39;</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">addMethodCall</span><span class="p">(</span><span class="s1">&#39;addSubscriber&#39;</span><span class="p">,</span> <span class="p">[</span><span class="k">new</span> <span class="nx">Reference</span><span class="p">(</span><span class="s1">&#39;listener.string_response&#39;</span><span class="p">)])</span>
<span class="p">;</span>
</pre></div>
</div>
<p>Besides describing your objects, the dependency injection container can also be
configured via parameters. Let’s create one that defines if we are in debug
mode or not:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$container</span><span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>

<span class="k">echo</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">getParameter</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>These parameters can be used when defining object definitions. Let’s make the
charset configurable:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// ...</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;listener.response&#39;</span><span class="p">,</span> <span class="nx">HttpKernel\EventListener\ResponseListener</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">setArguments</span><span class="p">([</span><span class="s1">&#39;%charset%&#39;</span><span class="p">])</span>
<span class="p">;</span>
</pre></div>
</div>
<p>After this change, you must set the charset before using the response listener
object:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$container</span><span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;charset&#39;</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>Instead of relying on the convention that the routes are defined by the
<code class="docutils literal notranslate"><span class="pre">$routes</span></code> variables, let’s use a parameter again:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// ...</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;matcher&#39;</span><span class="p">,</span> <span class="nx">Routing\Matcher\UrlMatcher</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">setArguments</span><span class="p">([</span><span class="s1">&#39;%routes%&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Reference</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">)])</span>
<span class="p">;</span>
</pre></div>
</div>
<p>And the related change in the front controller:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$container</span><span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;routes&#39;</span><span class="p">,</span> <span class="k">include</span> <span class="no">__DIR__</span><span class="o">.</span><span class="s1">&#39;/../src/app.php&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>We have barely scratched the surface of what you can do with the
container: from class names as parameters, to overriding existing object
definitions, from shared service support to dumping a container to a plain PHP class,
and much more. The Symfony dependency injection container is really powerful
and is able to manage any kind of PHP class.</p>
<p>Don’t yell at me if you don’t want to use a dependency injection container in
your framework. If you don’t like it, don’t use it. It’s your framework, not
mine.</p>
<p>This is (already) the last chapter of this book on creating a framework on top
of the Symfony components. I’m aware that many topics have not been covered
in great details, but hopefully it gives you enough information to get started
on your own and to better understand how the Symfony framework works
internally.</p>
<p>Have fun!</p>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>