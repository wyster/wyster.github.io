<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>Working with Server Side Includes</title>
    <link rel="stylesheet" href="../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/rtd_custom.css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="working-with-server-side-includes">
<span id="server-side-includes"></span><span id="index-0"></span><h1>Working with Server Side Includes</h1>
<p>In a similar way as <a class="reference internal" href="esi.xhtml"><span class="doc">ESI (Edge Side Includes)</span></a>,
SSI can be used to control HTTP caching on fragments of a response.
The most important difference that is SSI is known directly by most
web servers like <a class="reference external" href="https://httpd.apache.org/docs/current/en/howto/ssi.html">Apache</a><span class="link-target"> [https://httpd.apache.org/docs/current/en/howto/ssi.html]</span>, <a class="reference external" href="https://nginx.org/en/docs/http/ngx_http_ssi_module.html">Nginx</a><span class="link-target"> [https://nginx.org/en/docs/http/ngx_http_ssi_module.html]</span> etc.</p>
<p>The SSI instructions are done via HTML comments:</p>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="c">&lt;!-- ... some content --&gt;</span>

        <span class="c">&lt;!-- Embed the content of another page here --&gt;</span>
        <span class="c">&lt;!--#include virtual=&quot;http://...&quot; --&gt;</span>

        <span class="c">&lt;!-- ... more content --&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div>
<p>There are some other <a class="reference external" href="https://en.wikipedia.org/wiki/Server_Side_Includes#Directives">available directives</a><span class="link-target"> [https://en.wikipedia.org/wiki/Server_Side_Includes#Directives]</span> but
Symfony manages only the <code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">virtual</span></code> one.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Be careful with SSI, your website may be victim of injections.
Please read this <a class="reference external" href="https://www.owasp.org/index.php/Server-Side_Includes_(SSI)_Injection">OWASP article</a><span class="link-target"> [https://www.owasp.org/index.php/Server-Side_Includes_(SSI)_Injection]</span> first!</p>
</div>
<p>When the web server reads an SSI directive, it requests the given URI or gives
directly from its cache. It repeats this process until there is no more
SSI directives to handle. Then, it merges all responses into one and sends
it to the client.</p>
<div class="section" id="using-ssi-in-symfony">
<span id="id1"></span><h2>Using SSI in Symfony</h2>
<p>First, to use SSI, be sure to enable it in your application configuration:</p>
<div class="configuration-block">
<ul class="simple">
<li><p><em>YAML</em><div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># config/packages/framework.yaml</span>
<span class="l l-Scalar l-Scalar-Plain">framework</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">ssi</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{</span> <span class="nv">enabled</span><span class="p p-Indicator">:</span> <span class="nv">true</span> <span class="p p-Indicator">}</span>
</pre></div>
</td></tr></table></div>
</p></li>
<li><p><em>XML</em><div class="highlight-xml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- config/packages/framework.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="nt">&lt;container</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/dic/symfony&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:framework=</span><span class="s">&quot;http://symfony.com/schema/dic/symfony&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/dic/services</span>
<span class="s">        https://symfony.com/schema/dic/services/services-1.0.xsd</span>
<span class="s">        http://symfony.com/schema/dic/symfony</span>
<span class="s">        https://symfony.com/schema/dic/symfony/symfony-1.0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;framework:config&gt;</span>
        <span class="nt">&lt;framework:ssi</span> <span class="na">enabled=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/framework:config&gt;</span>
<span class="nt">&lt;/container&gt;</span>
</pre></div>
</td></tr></table></div>
</p></li>
<li><p><em>PHP</em><div class="highlight-php notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// config/packages/framework.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;framework&#39;</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">&#39;ssi&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;enabled&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">],</span>
<span class="p">]);</span>
</pre></div>
</td></tr></table></div>
</p></li>
</ul>
</div>
<p>Suppose you have a page with private content like a Profile page and you want
to cache a static GDPR content block. With SSI, you can add some expiration
on this block and keep the page private:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/Controller/ProfileController.php</span>
<span class="k">namespace</span> <span class="nx">App\Controller</span><span class="p">;</span>

<span class="c1">// ...</span>
<span class="k">class</span> <span class="nc">ProfileController</span> <span class="k">extends</span> <span class="nx">AbstractController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span><span class="o">:</span> <span class="nx">Response</span>
    <span class="p">{</span>
        <span class="c1">// by default, responses are private</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;profile/index.html.twig&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">gdpr</span><span class="p">()</span><span class="o">:</span> <span class="nx">Response</span>
    <span class="p">{</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;profile/gdpr.html.twig&#39;</span><span class="p">);</span>

        <span class="c1">// sets to public and adds some expiration</span>
        <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">setSharedMaxAge</span><span class="p">(</span><span class="mi">600</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The profile index page has not public caching, but the GDPR block has
10 minutes of expiration. Letâ€™s include this block into the main one:</p>
<div class="highlight-twig notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">{# templates/profile/index.html.twig #}</span><span class="x"></span>

<span class="c">{# you can use a controller reference #}</span><span class="x"></span>
<span class="cp">{{</span> <span class="nv">render_ssi</span><span class="o">(</span><span class="nv">controller</span><span class="o">(</span><span class="s1">&#39;App\\Controller\\ProfileController::gdpr&#39;</span><span class="o">))</span> <span class="cp">}}</span><span class="x"></span>

<span class="c">{# ... or a URL #}</span><span class="x"></span>
<span class="cp">{{</span> <span class="nv">render_ssi</span><span class="o">(</span><span class="nv">url</span><span class="o">(</span><span class="s1">&#39;profile_gdpr&#39;</span><span class="o">))</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>
</td></tr></table></div>
<p>The <code class="docutils literal notranslate"><span class="pre">render_ssi</span></code> twig helper will generate something like:</p>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!--#include virtual=&quot;/_fragment?_hash=abcdef1234&amp;_path=_controller=App\Controller\ProfileController::gdpr&quot; --&gt;</span>
</pre></div>
</td></tr></table></div>
<p><code class="docutils literal notranslate"><span class="pre">render_ssi</span></code> ensures that SSI directive are generated only if the request
has the header requirement like <code class="docutils literal notranslate"><span class="pre">Surrogate-Capability:</span> <span class="pre">device=&quot;SSI/1.0&quot;</span></code>
(normally given by the web server).
Otherwise it will embed directly the sub-response.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For more information about Symfony cache fragments, take a tour on
the <a class="reference internal" href="esi.xhtml#http-cache-fragments"><span class="std std-ref">ESI documentation</span></a>.</p>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>