<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>How to Work with multiple Entity Managers and Connections</title>
    <link rel="stylesheet" href="../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/rtd_custom.css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="how-to-work-with-multiple-entity-managers-and-connections">
<span id="index-0"></span><h1>How to Work with multiple Entity Managers and Connections</h1>
<p>You can use multiple Doctrine entity managers or connections in a Symfony
application. This is necessary if you are using different databases or even
vendors with entirely different sets of entities. In other words, one entity
manager that connects to one database will handle some entities while another
entity manager that connects to another database might handle the rest.
It is also possible to use multiple entity managers to manage a common set of
entities, each with their own database connection strings or separate cache configuration.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Using multiple entity managers is not complicated to configure, but more
advanced and not usually required. Be sure you actually need multiple
entity managers before adding in this layer of complexity.</p>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Entities cannot define associations across different entity managers. If you
need that, there are <a class="reference external" href="https://stackoverflow.com/a/11494543">several alternatives</a><span class="link-target"> [https://stackoverflow.com/a/11494543]</span> that require some custom setup.</p>
</div>
<p>The following configuration code shows how you can configure two entity managers:</p>
<div class="configuration-block">
<ul class="simple">
<li><p><em>YAML</em><div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># config/packages/doctrine.yaml</span>
<span class="l l-Scalar l-Scalar-Plain">doctrine</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">dbal</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">default_connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
        <span class="l l-Scalar l-Scalar-Plain">connections</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">default</span><span class="p p-Indicator">:</span>
                <span class="c1"># configure these for your database server</span>
                <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="s">&#39;%env(resolve:DATABASE_URL)%&#39;</span>
                <span class="l l-Scalar l-Scalar-Plain">driver</span><span class="p p-Indicator">:</span> <span class="s">&#39;pdo_mysql&#39;</span>
                <span class="l l-Scalar l-Scalar-Plain">server_version</span><span class="p p-Indicator">:</span> <span class="s">&#39;5.7&#39;</span>
                <span class="l l-Scalar l-Scalar-Plain">charset</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">utf8mb4</span>
            <span class="l l-Scalar l-Scalar-Plain">customer</span><span class="p p-Indicator">:</span>
                <span class="c1"># configure these for your database server</span>
                <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="s">&#39;%env(resolve:DATABASE_CUSTOMER_URL)%&#39;</span>
                <span class="l l-Scalar l-Scalar-Plain">driver</span><span class="p p-Indicator">:</span> <span class="s">&#39;pdo_mysql&#39;</span>
                <span class="l l-Scalar l-Scalar-Plain">server_version</span><span class="p p-Indicator">:</span> <span class="s">&#39;5.7&#39;</span>
                <span class="l l-Scalar l-Scalar-Plain">charset</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">utf8mb4</span>
    <span class="l l-Scalar l-Scalar-Plain">orm</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">default_entity_manager</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
        <span class="l l-Scalar l-Scalar-Plain">entity_managers</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">default</span><span class="p p-Indicator">:</span>
                <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
                <span class="l l-Scalar l-Scalar-Plain">mappings</span><span class="p p-Indicator">:</span>
                    <span class="l l-Scalar l-Scalar-Plain">Main</span><span class="p p-Indicator">:</span>
                        <span class="l l-Scalar l-Scalar-Plain">is_bundle</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
                        <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">annotation</span>
                        <span class="l l-Scalar l-Scalar-Plain">dir</span><span class="p p-Indicator">:</span> <span class="s">&#39;%kernel.project_dir%/src/Entity/Main&#39;</span>
                        <span class="l l-Scalar l-Scalar-Plain">prefix</span><span class="p p-Indicator">:</span> <span class="s">&#39;App\Entity\Main&#39;</span>
                        <span class="l l-Scalar l-Scalar-Plain">alias</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Main</span>
            <span class="l l-Scalar l-Scalar-Plain">customer</span><span class="p p-Indicator">:</span>
                <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">customer</span>
                <span class="l l-Scalar l-Scalar-Plain">mappings</span><span class="p p-Indicator">:</span>
                    <span class="l l-Scalar l-Scalar-Plain">Customer</span><span class="p p-Indicator">:</span>
                        <span class="l l-Scalar l-Scalar-Plain">is_bundle</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
                        <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">annotation</span>
                        <span class="l l-Scalar l-Scalar-Plain">dir</span><span class="p p-Indicator">:</span> <span class="s">&#39;%kernel.project_dir%/src/Entity/Customer&#39;</span>
                        <span class="l l-Scalar l-Scalar-Plain">prefix</span><span class="p p-Indicator">:</span> <span class="s">&#39;App\Entity\Customer&#39;</span>
                        <span class="l l-Scalar l-Scalar-Plain">alias</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Customer</span>
</pre></div>
</td></tr></table></div>
</p></li>
<li><p><em>XML</em><div class="highlight-xml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- config/packages/doctrine.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;container</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/dic/services&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:doctrine=</span><span class="s">&quot;http://symfony.com/schema/dic/doctrine&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/dic/services</span>
<span class="s">        https://symfony.com/schema/dic/services/services-1.0.xsd</span>
<span class="s">        http://symfony.com/schema/dic/doctrine</span>
<span class="s">        https://symfony.com/schema/dic/doctrine/doctrine-1.0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;doctrine:config&gt;</span>
        <span class="nt">&lt;doctrine:dbal</span> <span class="na">default-connection=</span><span class="s">&quot;default&quot;</span><span class="nt">&gt;</span>
            <span class="c">&lt;!-- configure these for your database server --&gt;</span>
            <span class="nt">&lt;doctrine:connection</span> <span class="na">name=</span><span class="s">&quot;default&quot;</span>
                <span class="na">url=</span><span class="s">&quot;%env(resolve:DATABASE_URL)%&quot;</span>
                <span class="na">driver=</span><span class="s">&quot;pdo_mysql&quot;</span>
                <span class="na">server_version=</span><span class="s">&quot;5.7&quot;</span>
                <span class="na">charset=</span><span class="s">&quot;utf8mb4&quot;</span>
            <span class="nt">/&gt;</span>

            <span class="c">&lt;!-- configure these for your database server --&gt;</span>
            <span class="nt">&lt;doctrine:connection</span> <span class="na">name=</span><span class="s">&quot;customer&quot;</span>
                <span class="na">url=</span><span class="s">&quot;%env(resolve:DATABASE_CUSTOMER_URL)%&quot;</span>
                <span class="na">driver=</span><span class="s">&quot;pdo_mysql&quot;</span>
                <span class="na">server_version=</span><span class="s">&quot;5.7&quot;</span>
                <span class="na">charset=</span><span class="s">&quot;utf8mb4&quot;</span>
            <span class="nt">/&gt;</span>
        <span class="nt">&lt;/doctrine:dbal&gt;</span>

        <span class="nt">&lt;doctrine:orm</span> <span class="na">default-entity-manager=</span><span class="s">&quot;default&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;doctrine:entity-manager</span> <span class="na">name=</span><span class="s">&quot;default&quot;</span> <span class="na">connection=</span><span class="s">&quot;default&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;doctrine:mapping</span>
                    <span class="na">name=</span><span class="s">&quot;Main&quot;</span>
                    <span class="na">is_bundle=</span><span class="s">&quot;false&quot;</span>
                    <span class="na">type=</span><span class="s">&quot;annotation&quot;</span>
                    <span class="na">dir=</span><span class="s">&quot;%kernel.project_dir%/src/Entity/Main&quot;</span>
                    <span class="na">prefix=</span><span class="s">&quot;App\Entity\Main&quot;</span>
                    <span class="na">alias=</span><span class="s">&quot;Main&quot;</span>
                <span class="nt">/&gt;</span>
            <span class="nt">&lt;/doctrine:entity-manager&gt;</span>

            <span class="nt">&lt;doctrine:entity-manager</span> <span class="na">name=</span><span class="s">&quot;customer&quot;</span> <span class="na">connection=</span><span class="s">&quot;customer&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;doctrine:mapping</span>
                    <span class="na">name=</span><span class="s">&quot;Customer&quot;</span>
                    <span class="na">is_bundle=</span><span class="s">&quot;false&quot;</span>
                    <span class="na">type=</span><span class="s">&quot;annotation&quot;</span>
                    <span class="na">dir=</span><span class="s">&quot;%kernel.project_dir%/src/Entity/Customer&quot;</span>
                    <span class="na">prefix=</span><span class="s">&quot;App\Entity\Customer&quot;</span>
                    <span class="na">alias=</span><span class="s">&quot;Customer&quot;</span>
                <span class="nt">/&gt;</span>
            <span class="nt">&lt;/doctrine:entity-manager&gt;</span>
        <span class="nt">&lt;/doctrine:orm&gt;</span>
    <span class="nt">&lt;/doctrine:config&gt;</span>
<span class="nt">&lt;/container&gt;</span>
</pre></div>
</td></tr></table></div>
</p></li>
<li><p><em>PHP</em><div class="highlight-php notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// config/packages/doctrine.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;doctrine&#39;</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">&#39;dbal&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;default_connection&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
        <span class="s1">&#39;connections&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="c1">// configure these for your database server</span>
            <span class="s1">&#39;default&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">&#39;url&#39;</span>            <span class="o">=&gt;</span> <span class="s1">&#39;%env(resolve:DATABASE_URL)%&#39;</span><span class="p">,</span>
                <span class="s1">&#39;driver&#39;</span>         <span class="o">=&gt;</span> <span class="s1">&#39;pdo_mysql&#39;</span><span class="p">,</span>
                <span class="s1">&#39;server_version&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;5.7&#39;</span><span class="p">,</span>
                <span class="s1">&#39;charset&#39;</span>        <span class="o">=&gt;</span> <span class="s1">&#39;utf8mb4&#39;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="c1">// configure these for your database server</span>
            <span class="s1">&#39;customer&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">&#39;url&#39;</span>            <span class="o">=&gt;</span> <span class="s1">&#39;%env(resolve:DATABASE_CUSTOMER_URL)%&#39;</span><span class="p">,</span>
                <span class="s1">&#39;driver&#39;</span>         <span class="o">=&gt;</span> <span class="s1">&#39;pdo_mysql&#39;</span><span class="p">,</span>
                <span class="s1">&#39;server_version&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;5.7&#39;</span><span class="p">,</span>
                <span class="s1">&#39;charset&#39;</span>        <span class="o">=&gt;</span> <span class="s1">&#39;utf8mb4&#39;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">],</span>
    <span class="p">],</span>

    <span class="s1">&#39;orm&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;default_entity_manager&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
        <span class="s1">&#39;entity_managers&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;default&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">&#39;connection&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mappings&#39;</span>   <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="s1">&#39;Main&#39;</span>  <span class="o">=&gt;</span> <span class="p">[</span>
                        <span class="s1">&#39;is_bundle&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;annotation&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;dir&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;%kernel.project_dir%/src/Entity/Main&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;prefix&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;App\Entity\Main&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;alias&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Main&#39;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">],</span>
            <span class="p">],</span>
            <span class="s1">&#39;customer&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">&#39;connection&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;customer&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mappings&#39;</span>   <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="s1">&#39;Customer&#39;</span>  <span class="o">=&gt;</span> <span class="p">[</span>
                        <span class="s1">&#39;is_bundle&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;annotation&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;dir&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;%kernel.project_dir%/src/Entity/Customer&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;prefix&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;App\Entity\Customer&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;alias&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Customer&#39;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">],</span>
            <span class="p">],</span>
        <span class="p">],</span>
    <span class="p">],</span>
<span class="p">]);</span>
</pre></div>
</td></tr></table></div>
</p></li>
</ul>
</div>
<p>In this case, you’ve defined two entity managers and called them <code class="docutils literal notranslate"><span class="pre">default</span></code>
and <code class="docutils literal notranslate"><span class="pre">customer</span></code>. The <code class="docutils literal notranslate"><span class="pre">default</span></code> entity manager manages entities in the
<code class="docutils literal notranslate"><span class="pre">src/Entity/Main</span></code> directory, while the <code class="docutils literal notranslate"><span class="pre">customer</span></code> entity manager manages
entities in <code class="docutils literal notranslate"><span class="pre">src/Entity/Customer</span></code>. You’ve also defined two connections, one
for each entity manager, but you are free to define the same connection for both.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>When working with multiple connections and entity managers, you should be
explicit about which configuration you want. If you <em>do</em> omit the name of
the connection or entity manager, the default (i.e. <code class="docutils literal notranslate"><span class="pre">default</span></code>) is used.</p>
<p>If you use a different name than <code class="docutils literal notranslate"><span class="pre">default</span></code> for the default entity manager,
you will need to redefine the default entity manager in the <code class="docutils literal notranslate"><span class="pre">prod</span></code> environment
configuration and in the Doctrine migrations configuration (if you use that):</p>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># config/packages/prod/doctrine.yaml</span>
<span class="l l-Scalar l-Scalar-Plain">doctrine</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">orm</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">default_entity_manager</span><span class="p p-Indicator">:</span> <span class="s">&#39;your</span><span class="nv"> </span><span class="s">default</span><span class="nv"> </span><span class="s">entity</span><span class="nv"> </span><span class="s">manager</span><span class="nv"> </span><span class="s">name&#39;</span>

<span class="c1"># ...</span>
</pre></div>
</td></tr></table></div>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># config/packages/doctrine_migrations.yaml</span>
<span class="l l-Scalar l-Scalar-Plain">doctrine_migrations</span><span class="p p-Indicator">:</span>
    <span class="c1"># ...</span>
    <span class="l l-Scalar l-Scalar-Plain">em</span><span class="p p-Indicator">:</span> <span class="s">&#39;your</span><span class="nv"> </span><span class="s">default</span><span class="nv"> </span><span class="s">entity</span><span class="nv"> </span><span class="s">manager</span><span class="nv"> </span><span class="s">name&#39;</span>
</pre></div>
</td></tr></table></div>
</div>
<p>When working with multiple connections to create your databases:</p>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Play only with &quot;default&quot; connection</span>
<span class="gp">$</span> php bin/console doctrine:database:create

<span class="c1"># Play only with &quot;customer&quot; connection</span>
<span class="gp">$</span> php bin/console doctrine:database:create --connection<span class="o">=</span>customer
</pre></div>
</td></tr></table></div>
<p>When working with multiple entity managers to generate migrations:</p>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Play only with &quot;default&quot; mappings</span>
<span class="gp">$</span> php bin/console doctrine:migrations:diff
<span class="gp">$</span> php bin/console doctrine:migrations:migrate

<span class="c1"># Play only with &quot;customer&quot; mappings</span>
<span class="gp">$</span> php bin/console doctrine:migrations:diff --em<span class="o">=</span>customer
<span class="gp">$</span> php bin/console doctrine:migrations:migrate --em<span class="o">=</span>customer
</pre></div>
</td></tr></table></div>
<p>If you <em>do</em> omit the entity manager’s name when asking for it,
the default entity manager (i.e. <code class="docutils literal notranslate"><span class="pre">default</span></code>) is returned:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/Controller/UserController.php</span>
<span class="k">namespace</span> <span class="nx">App\Controller</span><span class="p">;</span>

<span class="c1">// ...</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityManagerInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserController</span> <span class="k">extends</span> <span class="nx">AbstractController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">(</span><span class="nx">EntityManagerInterface</span> <span class="nv">$entityManager</span><span class="p">)</span><span class="o">:</span> <span class="nx">Response</span>
    <span class="p">{</span>
        <span class="c1">// These methods also return the default entity manager, but it&#39;s preferred</span>
        <span class="c1">// to get it by injecting EntityManagerInterface in the action method</span>
        <span class="nv">$entityManager</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>
        <span class="nv">$entityManager</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">);</span>
        <span class="nv">$entityManager</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;doctrine.orm.default_entity_manager&#39;</span><span class="p">);</span>

        <span class="c1">// Both of these return the &quot;customer&quot; entity manager</span>
        <span class="nv">$customerEntityManager</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">(</span><span class="s1">&#39;customer&#39;</span><span class="p">);</span>
        <span class="nv">$customerEntityManager</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;doctrine.orm.customer_entity_manager&#39;</span><span class="p">);</span>

        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can now use Doctrine like you did before - using the <code class="docutils literal notranslate"><span class="pre">default</span></code> entity
manager to persist and fetch entities that it manages and the <code class="docutils literal notranslate"><span class="pre">customer</span></code>
entity manager to persist and fetch its entities.</p>
<p>The same applies to repository calls:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/Controller/UserController.php</span>
<span class="k">namespace</span> <span class="nx">App\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">AcmeStoreBundle\Entity\Customer</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">AcmeStoreBundle\Entity\Product</span><span class="p">;</span>
<span class="c1">// ...</span>

<span class="k">class</span> <span class="nc">UserController</span> <span class="k">extends</span> <span class="nx">AbstractController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span><span class="o">:</span> <span class="nx">Response</span>
    <span class="p">{</span>
        <span class="c1">// Retrieves a repository managed by the &quot;default&quot; em</span>
        <span class="nv">$products</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">findAll</span><span class="p">()</span>
        <span class="p">;</span>

        <span class="c1">// Explicit way to deal with the &quot;default&quot; em</span>
        <span class="nv">$products</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">findAll</span><span class="p">()</span>
        <span class="p">;</span>

        <span class="c1">// Retrieves a repository managed by the &quot;customer&quot; em</span>
        <span class="nv">$customers</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">Customer</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;customer&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">findAll</span><span class="p">()</span>
        <span class="p">;</span>

        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>One entity can be managed by more than one entity manager. This however
results in unexpected behavior when extending from <code class="docutils literal notranslate"><span class="pre">ServiceEntityRepository</span></code>
in your custom repository. The <code class="docutils literal notranslate"><span class="pre">ServiceEntityRepository</span></code> always
uses the configured entity manager for that entity.</p>
<p>In order to fix this situation, extend <code class="docutils literal notranslate"><span class="pre">EntityRepository</span></code> instead and
no longer rely on autowiring:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/Repository/CustomerRepository.php</span>
<span class="k">namespace</span> <span class="nx">App\Repository</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityRepository</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CustomerRepository</span> <span class="k">extends</span> <span class="nx">EntityRepository</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="nx">You</span> <span class="nx">should</span> <span class="nx">now</span> <span class="nx">always</span> <span class="nx">fetch</span> <span class="k">this</span> <span class="nx">repository</span> <span class="nx">using</span> <span class="sb">``</span><span class="nx">ManagerRegistry</span><span class="o">::</span><span class="na">getRepository</span><span class="p">()</span><span class="sb">``</span><span class="o">.</span>
</pre></div>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>