<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>Databases and the Doctrine ORM</title>
    <link rel="stylesheet" href="_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/rtd_custom.css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="databases-and-the-doctrine-orm">
<span id="index-0"></span><h1>Databases and the Doctrine ORM</h1>
<div class="screencast admonition">
<p class="admonition-title">Screencast</p>
<p>Do you prefer video tutorials? Check out the <a class="reference external" href="https://symfonycasts.com/screencast/symfony-doctrine">Doctrine screencast series</a><span class="link-target"> [https://symfonycasts.com/screencast/symfony-doctrine]</span>.</p>
</div>
<p>Symfony provides all the tools you need to use databases in your applications
thanks to <a class="reference external" href="https://www.doctrine-project.org/">Doctrine</a><span class="link-target"> [https://www.doctrine-project.org/]</span>, the best set of PHP libraries to work with databases.
These tools support relational databases like MySQL and PostgreSQL and also
NoSQL databases like MongoDB.</p>
<p>Databases are a broad topic, so the documentation is divided in three articles:</p>
<ul class="simple">
<li><p>This article explains the recommended way to work with <strong>relational databases</strong>
in Symfony applications;</p></li>
<li><p>Read <a class="reference internal" href="doctrine/dbal.xhtml"><span class="doc">this other article</span></a> if you need <strong>low-level access</strong>
to perform raw SQL queries to relational databases (similar to PHP’s <a class="reference external" href="https://www.php.net/pdo">PDO</a><span class="link-target"> [https://www.php.net/pdo]</span>);</p></li>
<li><p>Read <a class="reference external" href="https://symfony.com/doc/current/bundles/DoctrineMongoDBBundle/index.html">DoctrineMongoDBBundle docs</a><span class="link-target"> [https://symfony.com/doc/current/bundles/DoctrineMongoDBBundle/index.html]</span> if you are working with <strong>MongoDB databases</strong>.</p></li>
</ul>
<div class="section" id="installing-doctrine">
<h2>Installing Doctrine</h2>
<p>First, install Doctrine support via the <code class="docutils literal notranslate"><span class="pre">orm</span></code> <a class="reference internal" href="setup.xhtml#symfony-packs"><span class="std std-ref">Symfony pack</span></a>,
as well as the MakerBundle, which will help generate some code:</p>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> composer require symfony/orm-pack
<span class="gp">$</span> composer require --dev symfony/maker-bundle
</pre></div>
</td></tr></table></div>
<div class="section" id="configuring-the-database">
<h3>Configuring the Database</h3>
<p>The database connection information is stored as an environment variable called
<code class="docutils literal notranslate"><span class="pre">DATABASE_URL</span></code>. For development, you can find and customize this inside <code class="docutils literal notranslate"><span class="pre">.env</span></code>:</p>
<div class="highlight-text notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span># .env (or override DATABASE_URL in .env.local to avoid committing your changes)

# customize this line!
DATABASE_URL=&quot;mysql://db_user:db_password@127.0.0.1:3306/db_name?serverVersion=5.7&quot;

# to use mariadb:
DATABASE_URL=&quot;mysql://db_user:db_password@127.0.0.1:3306/db_name?serverVersion=mariadb-10.5.8&quot;

# to use sqlite:
# DATABASE_URL=&quot;sqlite:///%kernel.project_dir%/var/app.db&quot;

# to use postgresql:
# DATABASE_URL=&quot;postgresql://db_user:db_password@127.0.0.1:5432/db_name?serverVersion=11&amp;charset=utf8&quot;
</pre></div>
</td></tr></table></div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>If the username, password, host or database name contain any character considered
special in a URI (such as <code class="docutils literal notranslate"><span class="pre">+</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;</span></code>, <code class="docutils literal notranslate"><span class="pre">$</span></code>, <code class="docutils literal notranslate"><span class="pre">#</span></code>, <code class="docutils literal notranslate"><span class="pre">/</span></code>, <code class="docutils literal notranslate"><span class="pre">:</span></code>, <code class="docutils literal notranslate"><span class="pre">*</span></code>, <code class="docutils literal notranslate"><span class="pre">!</span></code>),
you must encode them. See <a class="reference external" href="https://www.ietf.org/rfc/rfc3986.txt">RFC 3986</a><span class="link-target"> [https://www.ietf.org/rfc/rfc3986.txt]</span> for the full list of reserved characters or
use the <code class="docutils literal notranslate"><a class="reference external" href="https://www.php.net/manual/en/function.urlencode.php" title="urlencode"><span class="pre">urlencode</span></a><span class="link-target"> <span class="pre">[https://www.php.net/manual/en/function.urlencode.php]</span></span></code> function to encode them. In this case you need to
remove the <code class="docutils literal notranslate"><span class="pre">resolve:</span></code> prefix in <code class="docutils literal notranslate"><span class="pre">config/packages/doctrine.yaml</span></code> to avoid errors:
<code class="docutils literal notranslate"><span class="pre">url:</span> <span class="pre">'%env(resolve:DATABASE_URL)%'</span></code></p>
</div>
<p>Now that your connection parameters are setup, Doctrine can create the <code class="docutils literal notranslate"><span class="pre">db_name</span></code>
database for you:</p>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console doctrine:database:create
</pre></div>
</td></tr></table></div>
<p>There are more options in <code class="docutils literal notranslate"><span class="pre">config/packages/doctrine.yaml</span></code> that you can configure,
including your <code class="docutils literal notranslate"><span class="pre">server_version</span></code> (e.g. 5.7 if you’re using MySQL 5.7), which may
affect how Doctrine functions.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>There are many other Doctrine commands. Run <code class="docutils literal notranslate"><span class="pre">php</span> <span class="pre">bin/console</span> <span class="pre">list</span> <span class="pre">doctrine</span></code>
to see a full list.</p>
</div>
</div>
</div>
<div class="section" id="creating-an-entity-class">
<h2>Creating an Entity Class</h2>
<p>Suppose you’re building an application where products need to be displayed.
Without even thinking about Doctrine or databases, you already know that
you need a <code class="docutils literal notranslate"><span class="pre">Product</span></code> object to represent those products.</p>
<p id="doctrine-adding-mapping">You can use the <code class="docutils literal notranslate"><span class="pre">make:entity</span></code> command to create this class and any fields you
need. The command will ask you some questions - answer them like done below:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ php bin/console make:entity

Class name of the entity to create or update:
&gt; Product

New property name <span class="o">(</span>press &lt;<span class="k">return</span>&gt; to stop adding fields<span class="o">)</span>:
&gt; name

Field <span class="nb">type</span> <span class="o">(</span>enter ? to see all types<span class="o">)</span> <span class="o">[</span>string<span class="o">]</span>:
&gt; string

Field length <span class="o">[</span><span class="m">255</span><span class="o">]</span>:
&gt; <span class="m">255</span>

Can this field be null in the database <span class="o">(</span>nullable<span class="o">)</span> <span class="o">(</span>yes/no<span class="o">)</span> <span class="o">[</span>no<span class="o">]</span>:
&gt; no

New property name <span class="o">(</span>press &lt;<span class="k">return</span>&gt; to stop adding fields<span class="o">)</span>:
&gt; price

Field <span class="nb">type</span> <span class="o">(</span>enter ? to see all types<span class="o">)</span> <span class="o">[</span>string<span class="o">]</span>:
&gt; integer

Can this field be null in the database <span class="o">(</span>nullable<span class="o">)</span> <span class="o">(</span>yes/no<span class="o">)</span> <span class="o">[</span>no<span class="o">]</span>:
&gt; no

New property name <span class="o">(</span>press &lt;<span class="k">return</span>&gt; to stop adding fields<span class="o">)</span>:
&gt;
<span class="o">(</span>press enter again to finish<span class="o">)</span>
</pre></div>
</td></tr></table></div>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3: </span>The interactive behavior of the <code class="docutils literal notranslate"><span class="pre">make:entity</span></code> command was introduced
in MakerBundle 1.3.</p>
</div>
<p>Woh! You now have a new <code class="docutils literal notranslate"><span class="pre">src/Entity/Product.php</span></code> file:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/Entity/Product.php</span>
<span class="k">namespace</span> <span class="nx">App\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Repository\ProductRepository</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\Entity(repositoryClass=ProductRepository::class)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">Product</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @ORM\Id()</span>
<span class="sd">     * @ORM\GeneratedValue()</span>
<span class="sd">     * @ORM\Column(type=&quot;integer&quot;)</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;string&quot;, length=255)</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;integer&quot;)</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$price</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getId</span><span class="p">()</span><span class="o">:</span> <span class="o">?</span><span class="nx">int</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ... getter and setter methods</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Confused why the price is an integer? Don’t worry: this is just an example.
But, storing prices as integers (e.g. 100 = $1 USD) can avoid rounding issues.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are using an SQLite database, you’ll see the following error:
<em>PDOException: SQLSTATE[HY000]: General error: 1 Cannot add a NOT NULL
column with default value NULL</em>. Add a <code class="docutils literal notranslate"><span class="pre">nullable=true</span></code> option to the
<code class="docutils literal notranslate"><span class="pre">description</span></code> property to fix the problem.</p>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>There is a <a class="reference external" href="https://dev.mysql.com/doc/refman/5.6/en/innodb-limits.html">limit of 767 bytes for the index key prefix</a><span class="link-target"> [https://dev.mysql.com/doc/refman/5.6/en/innodb-limits.html]</span> when using
InnoDB tables in MySQL 5.6 and earlier versions. String columns with 255
character length and <code class="docutils literal notranslate"><span class="pre">utf8mb4</span></code> encoding surpass that limit. This means
that any column of type <code class="docutils literal notranslate"><span class="pre">string</span></code> and <code class="docutils literal notranslate"><span class="pre">unique=true</span></code> must set its
maximum <code class="docutils literal notranslate"><span class="pre">length</span></code> to <code class="docutils literal notranslate"><span class="pre">190</span></code>. Otherwise, you’ll see this error:
<em>“[PDOException] SQLSTATE[42000]: Syntax error or access violation:
1071 Specified key was too long; max key length is 767 bytes”</em>.</p>
</div>
<p>This class is called an “entity”. And soon, you’ll be able to save and query Product
objects to a <code class="docutils literal notranslate"><span class="pre">product</span></code> table in your database. Each property in the <code class="docutils literal notranslate"><span class="pre">Product</span></code>
entity can be mapped to a column in that table. This is usually done with annotations:
the <code class="docutils literal notranslate"><span class="pre">&#64;ORM\...</span></code> comments that you see above each property:</p>
<img alt="_images/mapping_single_entity.png" class="align-center" src="_images/mapping_single_entity.png" />
<p>The <code class="docutils literal notranslate"><span class="pre">make:entity</span></code> command is a tool to make life easier. But this is <em>your</em> code:
add/remove fields, add/remove methods or update configuration.</p>
<p>Doctrine supports a wide variety of field types, each with their own options.
To see a full list, check out <a class="reference external" href="https://www.doctrine-project.org/projects/doctrine-orm/en/current/reference/basic-mapping.html">Doctrine’s Mapping Types documentation</a><span class="link-target"> [https://www.doctrine-project.org/projects/doctrine-orm/en/current/reference/basic-mapping.html]</span>.
If you want to use XML instead of annotations, add <code class="docutils literal notranslate"><span class="pre">type:</span> <span class="pre">xml</span></code> and
<code class="docutils literal notranslate"><span class="pre">dir:</span> <span class="pre">'%kernel.project_dir%/config/doctrine'</span></code> to the entity mappings in your
<code class="docutils literal notranslate"><span class="pre">config/packages/doctrine.yaml</span></code> file.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Be careful not to use reserved SQL keywords as your table or column names
(e.g. <code class="docutils literal notranslate"><span class="pre">GROUP</span></code> or <code class="docutils literal notranslate"><span class="pre">USER</span></code>). See Doctrine’s <a class="reference external" href="https://www.doctrine-project.org/projects/doctrine-orm/en/current/reference/basic-mapping.html#quoting-reserved-words">Reserved SQL keywords documentation</a><span class="link-target"> [https://www.doctrine-project.org/projects/doctrine-orm/en/current/reference/basic-mapping.html#quoting-reserved-words]</span>
for details on how to escape these. Or, change the table name with
<code class="docutils literal notranslate"><span class="pre">&#64;ORM\Table(name=&quot;groups&quot;)</span></code> above the class or configure the column name with
the <code class="docutils literal notranslate"><span class="pre">name=&quot;group_name&quot;</span></code> option.</p>
</div>
</div>
<div class="section" id="migrations-creating-the-database-tables-schema">
<span id="doctrine-creating-the-database-tables-schema"></span><h2>Migrations: Creating the Database Tables/Schema</h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Product</span></code> class is fully-configured and ready to save to a <code class="docutils literal notranslate"><span class="pre">product</span></code> table.
If you just defined this class, your database doesn’t actually have the <code class="docutils literal notranslate"><span class="pre">product</span></code>
table yet. To add it, you can leverage the <a class="reference external" href="https://github.com/doctrine/DoctrineMigrationsBundle">DoctrineMigrationsBundle</a><span class="link-target"> [https://github.com/doctrine/DoctrineMigrationsBundle]</span>, which is
already installed:</p>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console make:migration
</pre></div>
</td></tr></table></div>
<p>If everything worked, you should see something like this:</p>
<blockquote>
<div><p>SUCCESS!</p>
<p>Next: Review the new migration “migrations/Version20180207231217.php”
Then: Run the migration with php bin/console doctrine:migrations:migrate</p>
</div></blockquote>
<p>If you open this file, it contains the SQL needed to update your database! To run
that SQL, execute your migrations:</p>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console doctrine:migrations:migrate
</pre></div>
</td></tr></table></div>
<p>This command executes all migration files that have not already been run against
your database. You should run this command on production when you deploy to keep
your production database up-to-date.</p>
</div>
<div class="section" id="migrations-adding-more-fields">
<span id="doctrine-add-more-fields"></span><h2>Migrations &amp; Adding more Fields</h2>
<p>But what if you need to add a new field property to <code class="docutils literal notranslate"><span class="pre">Product</span></code>, like a
<code class="docutils literal notranslate"><span class="pre">description</span></code>? You can edit the class to add the new property. But, you can
also use <code class="docutils literal notranslate"><span class="pre">make:entity</span></code> again:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ php bin/console make:entity

Class name of the entity to create or update
&gt; Product

New property name <span class="o">(</span>press &lt;<span class="k">return</span>&gt; to stop adding fields<span class="o">)</span>:
&gt; description

Field <span class="nb">type</span> <span class="o">(</span>enter ? to see all types<span class="o">)</span> <span class="o">[</span>string<span class="o">]</span>:
&gt; text

Can this field be null in the database <span class="o">(</span>nullable<span class="o">)</span> <span class="o">(</span>yes/no<span class="o">)</span> <span class="o">[</span>no<span class="o">]</span>:
&gt; no

New property name <span class="o">(</span>press &lt;<span class="k">return</span>&gt; to stop adding fields<span class="o">)</span>:
&gt;
<span class="o">(</span>press enter again to finish<span class="o">)</span>
</pre></div>
</td></tr></table></div>
<p>This adds the new <code class="docutils literal notranslate"><span class="pre">description</span></code> property and <code class="docutils literal notranslate"><span class="pre">getDescription()</span></code> and <code class="docutils literal notranslate"><span class="pre">setDescription()</span></code>
methods:</p>
<div class="highlight-diff notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span>// src/Entity/Product.php
// ...

class Product
{
    // ...

<span class="gi">+     /**</span>
<span class="gi">+      * @ORM\Column(type=&quot;text&quot;)</span>
<span class="gi">+      */</span>
<span class="gi">+     private $description;</span>

    // getDescription() &amp; setDescription() were also added
}
</pre></div>
</td></tr></table></div>
<p>The new property is mapped, but it doesn’t exist yet in the <code class="docutils literal notranslate"><span class="pre">product</span></code> table. No
problem! Generate a new migration:</p>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console make:migration
</pre></div>
</td></tr></table></div>
<p>This time, the SQL in the generated file will look like this:</p>
<div class="highlight-sql notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">product</span> <span class="k">ADD</span> <span class="n">description</span> <span class="n">LONGTEXT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</pre></div>
</td></tr></table></div>
<p>The migration system is <em>smart</em>. It compares all of your entities with the current
state of the database and generates the SQL needed to synchronize them! Like
before, execute your migrations:</p>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console doctrine:migrations:migrate
</pre></div>
</td></tr></table></div>
<p>This will only execute the <em>one</em> new migration file, because DoctrineMigrationsBundle
knows that the first migration was already executed earlier. Behind the scenes, it
manages a <code class="docutils literal notranslate"><span class="pre">migration_versions</span></code> table to track this.</p>
<p>Each time you make a change to your schema, run these two commands to generate the
migration and then execute it. Be sure to commit the migration files and execute
them when you deploy.</p>
<div class="admonition tip" id="doctrine-generating-getters-and-setters">
<p class="admonition-title">Tip</p>
<p>If you prefer to add new properties manually, the <code class="docutils literal notranslate"><span class="pre">make:entity</span></code> command can
generate the getter &amp; setter methods for you:</p>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console make:entity --regenerate
</pre></div>
</td></tr></table></div>
<p>If you make some changes and want to regenerate <em>all</em> getter/setter methods,
also pass <code class="docutils literal notranslate"><span class="pre">--overwrite</span></code>.</p>
</div>
</div>
<div class="section" id="persisting-objects-to-the-database">
<h2>Persisting Objects to the Database</h2>
<p>It’s time to save a <code class="docutils literal notranslate"><span class="pre">Product</span></code> object to the database! Let’s create a new controller
to experiment:</p>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console make:controller ProductController
</pre></div>
</td></tr></table></div>
<p>Inside the controller, you can create a new <code class="docutils literal notranslate"><span class="pre">Product</span></code> object, set data on it,
and save it:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/Controller/ProductController.php</span>
<span class="k">namespace</span> <span class="nx">App\Controller</span><span class="p">;</span>

<span class="c1">// ...</span>
<span class="k">use</span> <span class="nx">App\Entity\Product</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityManagerInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Response</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ProductController</span> <span class="k">extends</span> <span class="nx">AbstractController</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Route(&quot;/product&quot;, name=&quot;create_product&quot;)</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">createProduct</span><span class="p">()</span><span class="o">:</span> <span class="nx">Response</span>
    <span class="p">{</span>
        <span class="c1">// you can fetch the EntityManager via $this-&gt;getDoctrine()</span>
        <span class="c1">// or you can add an argument to the action: createProduct(EntityManagerInterface $entityManager)</span>
        <span class="nv">$entityManager</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>

        <span class="nv">$product</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Product</span><span class="p">();</span>
        <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="s1">&#39;Keyboard&#39;</span><span class="p">);</span>
        <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setPrice</span><span class="p">(</span><span class="mi">1999</span><span class="p">);</span>
        <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setDescription</span><span class="p">(</span><span class="s1">&#39;Ergonomic and stylish!&#39;</span><span class="p">);</span>

        <span class="c1">// tell Doctrine you want to (eventually) save the Product (no queries yet)</span>
        <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$product</span><span class="p">);</span>

        <span class="c1">// actually executes the queries (i.e. the INSERT query)</span>
        <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="s1">&#39;Saved new product with id &#39;</span><span class="o">.</span><span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Try it out!</p>
<blockquote>
<div><p><a class="reference external" href="http://localhost:8000/product">http://localhost:8000/product</a></p>
</div></blockquote>
<p>Congratulations! You just created your first row in the <code class="docutils literal notranslate"><span class="pre">product</span></code> table. To prove it,
you can query the database directly:</p>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console doctrine:query:sql <span class="s1">&#39;SELECT * FROM product&#39;</span>

<span class="c1"># on Windows systems not using Powershell, run this command instead:</span>
<span class="c1"># php bin/console doctrine:query:sql &quot;SELECT * FROM product&quot;</span>
</pre></div>
</td></tr></table></div>
<p>Take a look at the previous example in more detail:</p>
<ul class="simple" id="doctrine-entity-manager">
<li><p><strong>line 18</strong> The <code class="docutils literal notranslate"><span class="pre">$this-&gt;getDoctrine()-&gt;getManager()</span></code> method gets Doctrine’s
<em>entity manager</em> object, which is the most important object in Doctrine. It’s
responsible for saving objects to, and fetching objects from, the database.</p></li>
<li><p><strong>lines 20-23</strong> In this section, you instantiate and work with the <code class="docutils literal notranslate"><span class="pre">$product</span></code>
object like any other normal PHP object.</p></li>
<li><p><strong>line 26</strong> The <code class="docutils literal notranslate"><span class="pre">persist($product)</span></code> call tells Doctrine to “manage” the
<code class="docutils literal notranslate"><span class="pre">$product</span></code> object. This does <strong>not</strong> cause a query to be made to the database.</p></li>
<li><p><strong>line 29</strong> When the <code class="docutils literal notranslate"><span class="pre">flush()</span></code> method is called, Doctrine looks through
all of the objects that it’s managing to see if they need to be persisted
to the database. In this example, the <code class="docutils literal notranslate"><span class="pre">$product</span></code> object’s data doesn’t
exist in the database, so the entity manager executes an <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> query,
creating a new row in the <code class="docutils literal notranslate"><span class="pre">product</span></code> table.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the <code class="docutils literal notranslate"><span class="pre">flush()</span></code> call fails, a <code class="docutils literal notranslate"><span class="pre">Doctrine\ORM\ORMException</span></code> exception
is thrown. See <a class="reference external" href="https://www.doctrine-project.org/projects/doctrine-orm/en/current/reference/transactions-and-concurrency.html">Transactions and Concurrency</a><span class="link-target"> [https://www.doctrine-project.org/projects/doctrine-orm/en/current/reference/transactions-and-concurrency.html]</span>.</p>
</div>
<p>Whether you’re creating or updating objects, the workflow is always the same: Doctrine
is smart enough to know if it should INSERT or UPDATE your entity.</p>
</div>
<div class="section" id="validating-objects">
<span id="automatic-object-validation"></span><h2>Validating Objects</h2>
<p><a class="reference internal" href="validation.xhtml"><span class="doc">The Symfony validator</span></a> reuses Doctrine metadata to perform
some basic validation tasks:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/Controller/ProductController.php</span>
<span class="k">namespace</span> <span class="nx">App\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\Product</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Response</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Validator\Validator\ValidatorInterface</span><span class="p">;</span>
<span class="c1">// ...</span>

<span class="k">class</span> <span class="nc">ProductController</span> <span class="k">extends</span> <span class="nx">AbstractController</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Route(&quot;/product&quot;, name=&quot;create_product&quot;)</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">createProduct</span><span class="p">(</span><span class="nx">ValidatorInterface</span> <span class="nv">$validator</span><span class="p">)</span><span class="o">:</span> <span class="nx">Response</span>
    <span class="p">{</span>
        <span class="nv">$product</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Product</span><span class="p">();</span>
        <span class="c1">// This will trigger an error: the column isn&#39;t nullable in the database</span>
        <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>
        <span class="c1">// This will trigger a type mismatch error: an integer is expected</span>
        <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setPrice</span><span class="p">(</span><span class="s1">&#39;1999&#39;</span><span class="p">);</span>

        <span class="c1">// ...</span>

        <span class="nv">$errors</span> <span class="o">=</span> <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">(</span><span class="nv">$product</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">((</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$errors</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Although the <code class="docutils literal notranslate"><span class="pre">Product</span></code> entity doesn’t define any explicit
<a class="reference internal" href="validation.xhtml"><span class="doc">validation configuration</span></a>, Symfony introspects the Doctrine
mapping configuration to infer some validation rules. For example, given that
the <code class="docutils literal notranslate"><span class="pre">name</span></code> property can’t be <code class="docutils literal notranslate"><span class="pre">null</span></code> in the database, a
<a class="reference internal" href="reference/constraints/NotNull.xhtml"><span class="doc">NotNull constraint</span></a> is added automatically
to the property (if it doesn’t contain that constraint already).</p>
<p>The following table summarizes the mapping between Doctrine metadata and
the corresponding validation constraints added automatically by Symfony:</p>
<table class="docutils">
<colgroup>
<col style="width: 12%" />
<col style="width: 37%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Doctrine attribute</p></th>
<th class="head"><p>Validation constraint</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">nullable=false</span></code></p></td>
<td><p><a class="reference internal" href="reference/constraints/NotNull.xhtml"><span class="doc">NotNull</span></a></p></td>
<td><p>Requires installing the <a class="reference internal" href="components/property_info.xhtml"><span class="doc">PropertyInfo component</span></a></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">type</span></code></p></td>
<td><p><a class="reference internal" href="reference/constraints/Type.xhtml"><span class="doc">Type</span></a></p></td>
<td><p>Requires installing the <a class="reference internal" href="components/property_info.xhtml"><span class="doc">PropertyInfo component</span></a></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">unique=true</span></code></p></td>
<td><p><a class="reference internal" href="reference/constraints/UniqueEntity.xhtml"><span class="doc">UniqueEntity</span></a></p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">length</span></code></p></td>
<td><p><a class="reference internal" href="reference/constraints/Length.xhtml"><span class="doc">Length</span></a></p></td>
<td></td>
</tr>
</tbody>
</table>
<p>Because <a class="reference internal" href="forms.xhtml"><span class="doc">the Form component</span></a> as well as <a class="reference external" href="https://api-platform.com/docs/core/validation/">API Platform</a><span class="link-target"> [https://api-platform.com/docs/core/validation/]</span> internally
use the Validator component, all your forms and web APIs will also automatically
benefit from these automatic validation constraints.</p>
<p>This automatic validation is a nice feature to improve your productivity, but it
doesn’t replace the validation configuration entirely. You still need to add
some <a class="reference internal" href="reference/constraints.xhtml"><span class="doc">validation constraints</span></a> to ensure that data
provided by the user is correct.</p>
</div>
<div class="section" id="fetching-objects-from-the-database">
<h2>Fetching Objects from the Database</h2>
<p>Fetching an object back out of the database is even easier. Suppose you want to
be able to go to <code class="docutils literal notranslate"><span class="pre">/product/1</span></code> to see your new product:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/Controller/ProductController.php</span>
<span class="k">namespace</span> <span class="nx">App\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\Product</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Response</span><span class="p">;</span>
<span class="c1">// ...</span>

<span class="k">class</span> <span class="nc">ProductController</span> <span class="k">extends</span> <span class="nx">AbstractController</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Route(&quot;/product/{id}&quot;, name=&quot;product_show&quot;)</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">show</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$id</span><span class="p">)</span><span class="o">:</span> <span class="nx">Response</span>
    <span class="p">{</span>
        <span class="nv">$product</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNotFoundException</span><span class="p">(</span>
                <span class="s1">&#39;No product found for id &#39;</span><span class="o">.</span><span class="nv">$id</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="s1">&#39;Check out this great product: &#39;</span><span class="o">.</span><span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">());</span>

        <span class="c1">// or render a template</span>
        <span class="c1">// in the template, print things with {{ product.name }}</span>
        <span class="c1">// return $this-&gt;render(&#39;product/show.html.twig&#39;, [&#39;product&#39; =&gt; $product]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Another possibility is to use the <code class="docutils literal notranslate"><span class="pre">ProductRepository</span></code> using Symfony’s autowiring
and injected by the dependency injection container:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/Controller/ProductController.php</span>
<span class="k">namespace</span> <span class="nx">App\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\Product</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Repository\ProductRepository</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Response</span><span class="p">;</span>
<span class="c1">// ...</span>

<span class="k">class</span> <span class="nc">ProductController</span> <span class="k">extends</span> <span class="nx">AbstractController</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Route(&quot;/product/{id}&quot;, name=&quot;product_show&quot;)</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">show</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$id</span><span class="p">,</span> <span class="nx">ProductRepository</span> <span class="nv">$productRepository</span><span class="p">)</span><span class="o">:</span> <span class="nx">Response</span>
    <span class="p">{</span>
        <span class="nv">$product</span> <span class="o">=</span> <span class="nv">$productRepository</span>
            <span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Try it out!</p>
<blockquote>
<div><p><a class="reference external" href="http://localhost:8000/product/1">http://localhost:8000/product/1</a></p>
</div></blockquote>
<p>When you query for a particular type of object, you always use what’s known
as its “repository”. You can think of a repository as a PHP class whose only
job is to help you fetch entities of a certain class.</p>
<p>Once you have a repository object, you have many helper methods:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$repository</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

<span class="c1">// look for a single Product by its primary key (usually &quot;id&quot;)</span>
<span class="nv">$product</span> <span class="o">=</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

<span class="c1">// look for a single Product by name</span>
<span class="nv">$product</span> <span class="o">=</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">findOneBy</span><span class="p">([</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Keyboard&#39;</span><span class="p">]);</span>
<span class="c1">// or find by name and price</span>
<span class="nv">$product</span> <span class="o">=</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">findOneBy</span><span class="p">([</span>
    <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Keyboard&#39;</span><span class="p">,</span>
    <span class="s1">&#39;price&#39;</span> <span class="o">=&gt;</span> <span class="mi">1999</span><span class="p">,</span>
<span class="p">]);</span>

<span class="c1">// look for multiple Product objects matching the name, ordered by price</span>
<span class="nv">$products</span> <span class="o">=</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">findBy</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Keyboard&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;price&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ASC&#39;</span><span class="p">]</span>
<span class="p">);</span>

<span class="c1">// look for *all* Product objects</span>
<span class="nv">$products</span> <span class="o">=</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
<p>You can also add <em>custom</em> methods for more complex queries! More on that later in
the <a class="reference internal" href="#doctrine-queries"><span class="std std-ref">Querying for Objects: The Repository</span></a> section.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>When rendering an HTML page, the web debug toolbar at the bottom of the page
will display the number of queries and the time it took to execute them:</p>
<img alt="_images/doctrine_web_debug_toolbar.png" class="with-browser align-center" src="_images/doctrine_web_debug_toolbar.png" />
<p>If the number of database queries is too high, the icon will turn yellow to
indicate that something may not be correct. Click on the icon to open the
Symfony Profiler and see the exact queries that were executed. If you don’t
see the web debug toolbar, install the <code class="docutils literal notranslate"><span class="pre">profiler</span></code> <a class="reference internal" href="setup.xhtml#symfony-packs"><span class="std std-ref">Symfony pack</span></a>
by running this command: <code class="docutils literal notranslate"><span class="pre">composer</span> <span class="pre">require</span> <span class="pre">--dev</span> <span class="pre">symfony/profiler-pack</span></code>.</p>
</div>
</div>
<div class="section" id="automatically-fetching-objects-paramconverter">
<h2>Automatically Fetching Objects (ParamConverter)</h2>
<p>In many cases, you can use the <a class="reference external" href="https://symfony.com/doc/current/bundles/SensioFrameworkExtraBundle/index.html">SensioFrameworkExtraBundle</a><span class="link-target"> [https://symfony.com/doc/current/bundles/SensioFrameworkExtraBundle/index.html]</span> to do the query
for you automatically! First, install the bundle in case you don’t have it:</p>
<div class="highlight-terminal notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> composer require sensio/framework-extra-bundle
</pre></div>
</td></tr></table></div>
<p>Now, simplify your controller:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/Controller/ProductController.php</span>
<span class="k">namespace</span> <span class="nx">App\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\Product</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Repository\ProductRepository</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Response</span><span class="p">;</span>
<span class="c1">// ...</span>

<span class="k">class</span> <span class="nc">ProductController</span> <span class="k">extends</span> <span class="nx">AbstractController</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Route(&quot;/product/{id}&quot;, name=&quot;product_show&quot;)</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">show</span><span class="p">(</span><span class="nx">Product</span> <span class="nv">$product</span><span class="p">)</span><span class="o">:</span> <span class="nx">Response</span>
    <span class="p">{</span>
        <span class="c1">// use the Product!</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>That’s it! The bundle uses the <code class="docutils literal notranslate"><span class="pre">{id}</span></code> from the route to query for the <code class="docutils literal notranslate"><span class="pre">Product</span></code>
by the <code class="docutils literal notranslate"><span class="pre">id</span></code> column. If it’s not found, a 404 page is generated.</p>
<p>There are many more options you can use. Read more about the <a class="reference external" href="https://symfony.com/doc/current/bundles/SensioFrameworkExtraBundle/annotations/converters.html">ParamConverter</a><span class="link-target"> [https://symfony.com/doc/current/bundles/SensioFrameworkExtraBundle/annotations/converters.html]</span>.</p>
</div>
<div class="section" id="updating-an-object">
<h2>Updating an Object</h2>
<p>Once you’ve fetched an object from Doctrine, you interact with it the same as
with any PHP model:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/Controller/ProductController.php</span>
<span class="k">namespace</span> <span class="nx">App\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\Product</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Repository\ProductRepository</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Response</span><span class="p">;</span>
<span class="c1">// ...</span>

<span class="k">class</span> <span class="nc">ProductController</span> <span class="k">extends</span> <span class="nx">AbstractController</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Route(&quot;/product/edit/{id}&quot;)</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$id</span><span class="p">)</span><span class="o">:</span> <span class="nx">Response</span>
    <span class="p">{</span>
        <span class="nv">$entityManager</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>
        <span class="nv">$product</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNotFoundException</span><span class="p">(</span>
                <span class="s1">&#39;No product found for id &#39;</span><span class="o">.</span><span class="nv">$id</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="s1">&#39;New product name!&#39;</span><span class="p">);</span>
        <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirectToRoute</span><span class="p">(</span><span class="s1">&#39;product_show&#39;</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Using Doctrine to edit an existing product consists of three steps:</p>
<ol class="arabic simple">
<li><p>fetching the object from Doctrine;</p></li>
<li><p>modifying the object;</p></li>
<li><p>calling <code class="docutils literal notranslate"><span class="pre">flush()</span></code> on the entity manager.</p></li>
</ol>
<p>You <em>can</em> call <code class="docutils literal notranslate"><span class="pre">$entityManager-&gt;persist($product)</span></code>, but it isn’t necessary:
Doctrine is already “watching” your object for changes.</p>
</div>
<div class="section" id="deleting-an-object">
<h2>Deleting an Object</h2>
<p>Deleting an object is very similar, but requires a call to the <code class="docutils literal notranslate"><span class="pre">remove()</span></code>
method of the entity manager:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">remove</span><span class="p">(</span><span class="nv">$product</span><span class="p">);</span>
<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>
</pre></div>
</div>
<p>As you might expect, the <code class="docutils literal notranslate"><span class="pre">remove()</span></code> method notifies Doctrine that you’d
like to remove the given object from the database. The <code class="docutils literal notranslate"><span class="pre">DELETE</span></code> query isn’t
actually executed until the <code class="docutils literal notranslate"><span class="pre">flush()</span></code> method is called.</p>
</div>
<div class="section" id="querying-for-objects-the-repository">
<span id="doctrine-queries"></span><h2>Querying for Objects: The Repository</h2>
<p>You’ve already seen how the repository object allows you to run basic queries
without any work:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// from inside a controller</span>
<span class="nv">$repository</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

<span class="nv">$product</span> <span class="o">=</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
</pre></div>
</div>
<p>But what if you need a more complex query? When you generated your entity with
<code class="docutils literal notranslate"><span class="pre">make:entity</span></code>, the command <em>also</em> generated a <code class="docutils literal notranslate"><span class="pre">ProductRepository</span></code> class:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/Repository/ProductRepository.php</span>
<span class="k">namespace</span> <span class="nx">App\Repository</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\Product</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\Persistence\ManagerRegistry</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ProductRepository</span> <span class="k">extends</span> <span class="nx">ServiceEntityRepository</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">ManagerRegistry</span> <span class="nv">$registry</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$registry</span><span class="p">,</span> <span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When you fetch your repository (i.e. <code class="docutils literal notranslate"><span class="pre">-&gt;getRepository(Product::class)</span></code>), it is
<em>actually</em> an instance of <em>this</em> object! This is because of the <code class="docutils literal notranslate"><span class="pre">repositoryClass</span></code>
config that was generated at the top of your <code class="docutils literal notranslate"><span class="pre">Product</span></code> entity class.</p>
<p>Suppose you want to query for all Product objects greater than a certain price. Add
a new method for this to your repository:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/Repository/ProductRepository.php</span>

<span class="c1">// ...</span>
<span class="k">class</span> <span class="nc">ProductRepository</span> <span class="k">extends</span> <span class="nx">ServiceEntityRepository</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">ManagerRegistry</span> <span class="nv">$registry</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$registry</span><span class="p">,</span> <span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @return Product[]</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">findAllGreaterThanPrice</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$price</span><span class="p">)</span><span class="o">:</span> <span class="k">array</span>
    <span class="p">{</span>
        <span class="nv">$entityManager</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getEntityManager</span><span class="p">();</span>

        <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span>
            <span class="s1">&#39;SELECT p</span>
<span class="s1">            FROM App\Entity\Product p</span>
<span class="s1">            WHERE p.price &gt; :price</span>
<span class="s1">            ORDER BY p.price ASC&#39;</span>
        <span class="p">)</span><span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="nv">$price</span><span class="p">);</span>

        <span class="c1">// returns an array of Product objects</span>
        <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The string passed to <code class="docutils literal notranslate"><span class="pre">createQuery()</span></code> might look like SQL, but it is
<a class="reference external" href="https://www.doctrine-project.org/projects/doctrine-orm/en/current/reference/dql-doctrine-query-language.html">Doctrine Query Language</a><span class="link-target"> [https://www.doctrine-project.org/projects/doctrine-orm/en/current/reference/dql-doctrine-query-language.html]</span>. This allows you to type queries using commonly
known query language, but referencing PHP objects instead (i.e. in the <code class="docutils literal notranslate"><span class="pre">FROM</span></code>
statement).</p>
<p>Now, you can call this method on the repository:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// from inside a controller</span>
<span class="nv">$minPrice</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

<span class="nv">$products</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">findAllGreaterThanPrice</span><span class="p">(</span><span class="nv">$minPrice</span><span class="p">);</span>

<span class="c1">// ...</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="service_container.xhtml#services-constructor-injection"><span class="std std-ref">Injecting Services/Config into a Service</span></a> for how to inject the repository into
any service.</p>
<div class="section" id="querying-with-the-query-builder">
<h3>Querying with the Query Builder</h3>
<p>Doctrine also provides a <a class="reference external" href="https://www.doctrine-project.org/projects/doctrine-orm/en/current/reference/query-builder.html">Query Builder</a><span class="link-target"> [https://www.doctrine-project.org/projects/doctrine-orm/en/current/reference/query-builder.html]</span>, an object-oriented way to write
queries. It is recommended to use this when queries are built dynamically (i.e.
based on PHP conditions):</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/Repository/ProductRepository.php</span>

<span class="c1">// ...</span>
<span class="k">class</span> <span class="nc">ProductRepository</span> <span class="k">extends</span> <span class="nx">ServiceEntityRepository</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">findAllGreaterThanPrice</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$price</span><span class="p">,</span> <span class="nx">bool</span> <span class="nv">$includeUnavailableProducts</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span><span class="o">:</span> <span class="k">array</span>
    <span class="p">{</span>
        <span class="c1">// automatically knows to select Products</span>
        <span class="c1">// the &quot;p&quot; is an alias you&#39;ll use in the rest of the query</span>
        <span class="nv">$qb</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;p.price &gt; :price&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="nv">$price</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="s1">&#39;p.price&#39;</span><span class="p">,</span> <span class="s1">&#39;ASC&#39;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$includeUnavailableProducts</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">andWhere</span><span class="p">(</span><span class="s1">&#39;p.available = TRUE&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">();</span>

        <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>

        <span class="c1">// to get just one result:</span>
        <span class="c1">// $product = $query-&gt;setMaxResults(1)-&gt;getOneOrNullResult();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="querying-with-sql">
<h3>Querying with SQL</h3>
<p>In addition, you can query directly with SQL if you need to:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/Repository/ProductRepository.php</span>

<span class="c1">// ...</span>
<span class="k">class</span> <span class="nc">ProductRepository</span> <span class="k">extends</span> <span class="nx">ServiceEntityRepository</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">findAllGreaterThanPrice</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$price</span><span class="p">)</span><span class="o">:</span> <span class="k">array</span>
    <span class="p">{</span>
        <span class="nv">$conn</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getEntityManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getConnection</span><span class="p">();</span>

        <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">&#39;</span>
<span class="s1">            SELECT * FROM product p</span>
<span class="s1">            WHERE p.price &gt; :price</span>
<span class="s1">            ORDER BY p.price ASC</span>
<span class="s1">            &#39;</span><span class="p">;</span>
        <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
        <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="s1">&#39;price&#39;</span> <span class="o">=&gt;</span> <span class="nv">$price</span><span class="p">]);</span>

        <span class="c1">// returns an array of arrays (i.e. a raw data set)</span>
        <span class="k">return</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">fetchAllAssociative</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With SQL, you will get back raw data, not objects (unless you use the <a class="reference external" href="https://www.doctrine-project.org/projects/doctrine-orm/en/current/reference/native-sql.html">NativeQuery</a><span class="link-target"> [https://www.doctrine-project.org/projects/doctrine-orm/en/current/reference/native-sql.html]</span>
functionality).</p>
</div>
</div>
<div class="section" id="configuration">
<h2>Configuration</h2>
<p>See the <a class="reference internal" href="reference/configuration/doctrine.xhtml"><span class="doc">Doctrine config reference</span></a>.</p>
</div>
<div class="section" id="relationships-and-associations">
<h2>Relationships and Associations</h2>
<p>Doctrine provides all the functionality you need to manage database relationships
(also known as associations), including ManyToOne, OneToMany, OneToOne and ManyToMany
relationships.</p>
<p>For info, see <a class="reference internal" href="doctrine/associations.xhtml"><span class="doc">How to Work with Doctrine Associations / Relations</span></a>.</p>
</div>
<div class="section" id="database-testing">
<h2>Database Testing</h2>
<p>Read the article about <a class="reference internal" href="testing/database.xhtml"><span class="doc">testing code that interacts with the database</span></a>.</p>
</div>
<div class="section" id="doctrine-extensions-timestampable-translatable-etc">
<h2>Doctrine Extensions (Timestampable, Translatable, etc.)</h2>
<p>Doctrine community has created some extensions to implement common needs such as
<em>“set the value of the createdAt property automatically when creating an entity”</em>.
Read more about the <a class="reference external" href="https://github.com/Atlantic18/DoctrineExtensions">available Doctrine extensions</a><span class="link-target"> [https://github.com/Atlantic18/DoctrineExtensions]</span> and use the
<a class="reference external" href="https://github.com/stof/StofDoctrineExtensionsBundle">StofDoctrineExtensionsBundle</a><span class="link-target"> [https://github.com/stof/StofDoctrineExtensionsBundle]</span> to integrate them in your application.</p>
</div>
<div class="section" id="learn-more">
<h2>Learn more</h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="doctrine/associations.xhtml">How to Work with Doctrine Associations / Relations</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine/events.xhtml">Doctrine Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine/registration_form.xhtml">How to Implement a Registration Form</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine/custom_dql_functions.xhtml">How to Register custom DQL Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine/dbal.xhtml">How to Use Doctrine DBAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine/multiple_entity_managers.xhtml">How to Work with multiple Entity Managers and Connections</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine/resolve_target_entity.xhtml">How to Define Relationships with Abstract Classes and Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine/reverse_engineering.xhtml">How to Generate Entities from an Existing Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="session/database.xhtml">Store Sessions in a Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing/database.xhtml">How to Test Code that Interacts with the Database</a></li>
</ul>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>