<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>How To Create Symfony Applications with Multiple Kernels</title>
    <link rel="stylesheet" href="../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/rtd_custom.css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="how-to-create-symfony-applications-with-multiple-kernels">
<span id="index-0"></span><h1>How To Create Symfony Applications with Multiple Kernels</h1>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Creating applications with multiple kernels is no longer recommended by
Symfony. Consider creating multiple small applications instead.</p>
</div>
<p>In most Symfony applications, incoming requests are processed by the
<code class="docutils literal notranslate"><span class="pre">public/index.php</span></code> front controller, which instantiates the <code class="docutils literal notranslate"><span class="pre">src/Kernel.php</span></code>
class to create the application kernel that loads the bundles and handles the
request to generate the response.</p>
<p>This single kernel approach is a convenient default, but Symfony applications
can define any number of kernels. Whereas
<a class="reference internal" href="../configuration.xhtml#configuration-environments"><span class="std std-ref">environments</span></a> run the same application with
different configurations, kernels can run different parts of the same
application.</p>
<p>These are some of the common use cases for creating multiple kernels:</p>
<ul class="simple">
<li><p>An application that defines an API could define two kernels for performance
reasons. The first kernel would serve the regular application and the second
one would only respond to the API requests, loading less bundles and enabling
less features;</p></li>
<li><p>A highly sensitive application could define two kernels. The first one would
only load the routes that match the parts of the application exposed publicly.
The second kernel would load the rest of the application and its access would
be protected by the web server;</p></li>
<li><p>A micro-services oriented application could define several kernels to
enable/disable services selectively turning a traditional monolith application
into several micro-applications.</p></li>
</ul>
<div class="section" id="adding-a-new-kernel-to-the-application">
<h2>Adding a new Kernel to the Application</h2>
<p>Creating a new kernel in a Symfony application is a three-step process:</p>
<ol class="arabic simple">
<li><p>Create a new front controller to load the new kernel;</p></li>
<li><p>Create the new kernel class;</p></li>
<li><p>Define the configuration loaded by the new kernel.</p></li>
</ol>
<p>The following example shows how to create a new kernel for the API of a given
Symfony application.</p>
<div class="section" id="step-1-create-a-new-front-controller">
<h3>Step 1) Create a new Front Controller</h3>
<p>Instead of creating the new front controller from scratch, it’s easier to
duplicate the existing one. For example, create <code class="docutils literal notranslate"><span class="pre">public/api.php</span></code> from
<code class="docutils literal notranslate"><span class="pre">public/index.php</span></code>.</p>
<p>Then, update the code of the new front controller to instantiate the new kernel
class instead of the usual <code class="docutils literal notranslate"><span class="pre">Kernel</span></code> class:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// public/api.php</span>
<span class="c1">// ...</span>
<span class="nv">$kernel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ApiKernel</span><span class="p">(</span>
    <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;APP_ENV&#39;</span><span class="p">]</span> <span class="o">??</span> <span class="s1">&#39;dev&#39;</span><span class="p">,</span>
    <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;APP_DEBUG&#39;</span><span class="p">]</span> <span class="o">??</span> <span class="p">(</span><span class="s1">&#39;prod&#39;</span> <span class="o">!==</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;APP_ENV&#39;</span><span class="p">]</span> <span class="o">??</span> <span class="s1">&#39;dev&#39;</span><span class="p">))</span>
<span class="p">);</span>
<span class="c1">// ...</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Another approach is to keep the existing <code class="docutils literal notranslate"><span class="pre">index.php</span></code> front controller, but
add an <code class="docutils literal notranslate"><span class="pre">if</span></code> statement to load the different kernel based on the URL (e.g.
if the URL starts with <code class="docutils literal notranslate"><span class="pre">/api</span></code>, use the <code class="docutils literal notranslate"><span class="pre">ApiKernel</span></code>).</p>
</div>
</div>
<div class="section" id="step-2-create-the-new-kernel-class">
<h3>Step 2) Create the new Kernel Class</h3>
<p>Now you need to define the <code class="docutils literal notranslate"><span class="pre">ApiKernel</span></code> class used by the new front controller.
The easiest way to do this is by duplicating the existing  <code class="docutils literal notranslate"><span class="pre">src/Kernel.php</span></code>
file and make the needed changes.</p>
<p>In this example, the <code class="docutils literal notranslate"><span class="pre">ApiKernel</span></code> will load less bundles than the default
Kernel. Be sure to also change the location of the cache, logs and configuration
files so they don’t collide with the files from <code class="docutils literal notranslate"><span class="pre">src/Kernel.php</span></code>:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// src/ApiKernel.php</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Config\Loader\LoaderInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\DependencyInjection\ContainerBuilder</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpKernel\Kernel</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ApiKernel</span> <span class="k">extends</span> <span class="nx">Kernel</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">MicroKernelTrait</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">registerBundles</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// load only the bundles strictly needed for the API</span>
        <span class="nv">$contents</span> <span class="o">=</span> <span class="k">require</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getProjectDir</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;/config/api_bundles.php&#39;</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$contents</span> <span class="k">as</span> <span class="nv">$class</span> <span class="o">=&gt;</span> <span class="nv">$envs</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$envs</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">environment</span><span class="p">]</span> <span class="o">??</span> <span class="nv">$envs</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span> <span class="o">??</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">yield</span> <span class="k">new</span> <span class="nv">$class</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getProjectDir</span><span class="p">()</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">\dirname</span><span class="p">(</span><span class="no">__DIR__</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getCacheDir</span><span class="p">()</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getProjectDir</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;/var/cache/api/&#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getEnvironment</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getLogDir</span><span class="p">()</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getProjectDir</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;/var/log/api&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">configureContainer</span><span class="p">(</span><span class="nx">ContainerBuilder</span> <span class="nv">$container</span><span class="p">,</span> <span class="nx">LoaderInterface</span> <span class="nv">$loader</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">addResource</span><span class="p">(</span><span class="k">new</span> <span class="nx">FileResource</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getProjectDir</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;/config/api_bundles.php&#39;</span><span class="p">));</span>
        <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;container.dumper.inline_factories&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
        <span class="nv">$confDir</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getProjectDir</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;/config/api&#39;</span><span class="p">;</span>

        <span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="nv">$confDir</span><span class="o">.</span><span class="s1">&#39;/{packages}/*&#39;</span><span class="o">.</span><span class="nx">self</span><span class="o">::</span><span class="na">CONFIG_EXTS</span><span class="p">,</span> <span class="s1">&#39;glob&#39;</span><span class="p">);</span>
        <span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="nv">$confDir</span><span class="o">.</span><span class="s1">&#39;/{packages}/&#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">environment</span><span class="o">.</span><span class="s1">&#39;/*&#39;</span><span class="o">.</span><span class="nx">self</span><span class="o">::</span><span class="na">CONFIG_EXTS</span><span class="p">,</span> <span class="s1">&#39;glob&#39;</span><span class="p">);</span>
        <span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="nv">$confDir</span><span class="o">.</span><span class="s1">&#39;/{services}&#39;</span><span class="o">.</span><span class="nx">self</span><span class="o">::</span><span class="na">CONFIG_EXTS</span><span class="p">,</span> <span class="s1">&#39;glob&#39;</span><span class="p">);</span>
        <span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="nv">$confDir</span><span class="o">.</span><span class="s1">&#39;/{services}_&#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">environment</span><span class="o">.</span><span class="nx">self</span><span class="o">::</span><span class="na">CONFIG_EXTS</span><span class="p">,</span> <span class="s1">&#39;glob&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">configureRoutes</span><span class="p">(</span><span class="nx">RouteCollectionBuilder</span> <span class="nv">$routes</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="nv">$confDir</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getProjectDir</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;/config/api&#39;</span><span class="p">;</span>
        <span class="c1">// ... load only the config routes strictly needed for the API</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="step-3-define-the-kernel-configuration">
<h3>Step 3) Define the Kernel Configuration</h3>
<p>Finally, define the configuration files that the new <code class="docutils literal notranslate"><span class="pre">ApiKernel</span></code> will load.
According to the above code, this config will live in one or multiple files
stored in <code class="docutils literal notranslate"><span class="pre">config/api/</span></code> and <code class="docutils literal notranslate"><span class="pre">config/api/ENVIRONMENT_NAME/</span></code> directories.</p>
<p>The new configuration files can be created from scratch when you load only a few
bundles, because it will be small. Otherwise, duplicate the existing
config files in <code class="docutils literal notranslate"><span class="pre">config/packages/</span></code> or better, import them and override the
needed options.</p>
</div>
</div>
<div class="section" id="executing-commands-with-a-different-kernel">
<h2>Executing Commands with a Different Kernel</h2>
<p>The <code class="docutils literal notranslate"><span class="pre">bin/console</span></code> script used to run Symfony commands always uses the default
<code class="docutils literal notranslate"><span class="pre">Kernel</span></code> class to build the application and load the commands. If you need
to run console commands using the new kernel, duplicate the <code class="docutils literal notranslate"><span class="pre">bin/console</span></code>
script and rename it (e.g. <code class="docutils literal notranslate"><span class="pre">bin/api</span></code>).</p>
<p>Then, replace the <code class="docutils literal notranslate"><span class="pre">Kernel</span></code> instance by your own kernel instance
(e.g. <code class="docutils literal notranslate"><span class="pre">ApiKernel</span></code>). Now you can run commands using the new kernel
(e.g. <code class="docutils literal notranslate"><span class="pre">php</span> <span class="pre">bin/api</span> <span class="pre">cache:clear</span></code>).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The commands available for each console script (e.g. <code class="docutils literal notranslate"><span class="pre">bin/console</span></code> and
<code class="docutils literal notranslate"><span class="pre">bin/api</span></code>) can differ because they depend on the bundles enabled for each
kernel, which could be different.</p>
</div>
</div>
<div class="section" id="rendering-templates-defined-in-a-different-kernel">
<h2>Rendering Templates Defined in a Different Kernel</h2>
<p>If you follow the Symfony Best Practices, the templates of the default kernel
will be stored in <code class="docutils literal notranslate"><span class="pre">templates/</span></code>. Trying to render those templates in a
different kernel will result in a <em>There are no registered paths for namespace
“__main__”</em> error.</p>
<p>In order to solve this issue, add the following configuration to your kernel:</p>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># config/api/twig.yaml</span>
<span class="l l-Scalar l-Scalar-Plain">twig</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">paths</span><span class="p p-Indicator">:</span>
        <span class="c1"># allows to use api/templates/ dir in the ApiKernel</span>
        <span class="s">&quot;%kernel.project_dir%/api/templates&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">~</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="running-tests-using-a-different-kernel">
<h2>Running Tests Using a Different Kernel</h2>
<p>In Symfony applications, functional tests extend by default from the
<code class="docutils literal notranslate"><a class="reference external" href="https://github.com/symfony/symfony/blob/master/src/Symfony/Bundle/FrameworkBundle/Test/WebTestCase.php" title="Symfony\Bundle\FrameworkBundle\Test\WebTestCase"><span class="pre">WebTestCase</span></a><span class="link-target"> <span class="pre">[https://github.com/symfony/symfony/blob/master/src/Symfony/Bundle/FrameworkBundle/Test/WebTestCase.php]</span></span></code> class. Inside that
class, a method called <code class="docutils literal notranslate"><span class="pre">getKernelClass()</span></code> tries to find the class of the kernel
to use to run the application during tests. The logic of this method does not
support multiple kernel applications, so your tests won’t use the right kernel.</p>
<p>The solution is to create a custom base class for functional tests extending
from <code class="docutils literal notranslate"><span class="pre">WebTestCase</span></code> class and overriding the <code class="docutils literal notranslate"><span class="pre">getKernelClass()</span></code> method to
return the fully qualified class name of the kernel to use:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Test\WebTestCase</span><span class="p">;</span>

<span class="c1">// tests needing the ApiKernel to work, now must extend this</span>
<span class="c1">// ApiTestCase class instead of the default WebTestCase class</span>
<span class="k">class</span> <span class="nc">ApiTestCase</span> <span class="k">extends</span> <span class="nx">WebTestCase</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getKernelClass</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;App\ApiKernel&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// this is needed because the KernelTestCase class keeps a reference to</span>
    <span class="c1">// the previously created kernel in its static $kernel property. Thus,</span>
    <span class="c1">// if your functional tests do not run in isolated processes, a later run</span>
    <span class="c1">// test for a different kernel will reuse the previously created instance,</span>
    <span class="c1">// which points to a different kernel</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">tearDown</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">tearDown</span><span class="p">();</span>

        <span class="k">static</span><span class="o">::</span><span class="nv">$class</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="adding-more-kernels-to-the-application">
<h2>Adding more Kernels to the Application</h2>
<p>If your application is very complex and you create several kernels, it’s better
to store them in their own directories instead of messing with lots of files in
the default <code class="docutils literal notranslate"><span class="pre">src/</span></code> directory:</p>
<div class="highlight-text notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span>project/
├─ src/
│  ├─ ...
│  └─ Kernel.php
├─ api/
│  ├─ ...
│  └─ ApiKernel.php
├─ ...
└─ public/
    ├─ ...
    ├─ api.php
    └─ index.php
</pre></div>
</td></tr></table></div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>